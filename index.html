<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H&L WorkFlow Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0c0e14;
            --bg-secondary: #141820;
            --bg-tertiary: #1a1f2e;
            --bg-card: linear-gradient(145deg, #181d2a 0%, #1f2536 100%);
            --accent-teal: #00d4aa;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-green: #22c55e;
            --peacock: #039BE5;
            --tomato: #D32F2F;
            --sage: #33B679;
            --banana: #F6BF26;
            --tangerine: #F09300;
            --grape: #7986CB;
            --graphite: #616161;
            --code-blue: #1e40af;
            --code-red: #dc2626;
            --text-primary: #f0f4f8;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255,255,255,0.08);
            --glow: 0 0 40px rgba(0,212,170,0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.6; }
        
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;
            background: radial-gradient(ellipse at 15% 15%, rgba(0,212,170,0.06) 0%, transparent 50%),
                        radial-gradient(ellipse at 85% 85%, rgba(139,92,246,0.05) 0%, transparent 50%);
        }

        /* Alert Banners */
        .alert-container { position: sticky; top: 0; z-index: 200; }
        .alert-banner {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            animation: pulse 2s infinite;
        }
        .alert-code-blue { background: linear-gradient(90deg, var(--code-blue), #2563eb); }
        .alert-code-red { background: linear-gradient(90deg, var(--code-red), #ef4444); }
        .alert-peacock { background: linear-gradient(90deg, var(--peacock), #0284c7); }
        .alert-tomato { background: linear-gradient(90deg, var(--tomato), #ef4444); }
        .alert-leads { background: linear-gradient(90deg, var(--accent-green), #16a34a); }
        .alert-complaints { background: linear-gradient(90deg, var(--accent-amber), #d97706); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.9; } }
        .alert-banner .alert-icon { font-size: 1.5rem; }
        .alert-banner .alert-text { flex: 1; font-weight: 600; }
        .alert-banner .alert-count { 
            background: rgba(255,255,255,0.25); 
            padding: 0.25rem 0.75rem; 
            border-radius: 20px; 
            font-weight: 700;
            font-size: 0.9rem;
        }
        .alert-banner .alert-action {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .alert-banner .alert-action:hover { background: rgba(255,255,255,0.35); }
        .alert-hidden { display: none; }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(12,14,20,0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
        }
        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header-left { display: flex; align-items: center; gap: 1.5rem; }
        .logo { font-size: 1.5rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .fy-badge { background: var(--bg-tertiary); border: 1px solid var(--border); padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; color: var(--accent-teal); font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        
        .connection-pills { display: flex; gap: 0.5rem; }
        .conn-pill {
            display: flex; align-items: center; gap: 0.4rem;
            padding: 0.35rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.75rem;
        }
        .conn-dot { width: 8px; height: 8px; border-radius: 50%; }
        .conn-dot.on { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .conn-dot.off { background: var(--accent-rose); }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent-teal), #0d9488); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,212,170,0.3); }
        .btn-secondary { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--bg-card); }
        .btn-danger { background: linear-gradient(135deg, var(--accent-rose), #e11d48); color: white; }
        .btn-ceo { background: linear-gradient(135deg, var(--accent-purple), #7c3aed); color: white; }

        .container { position: relative; z-index: 1; max-width: 1800px; margin: 0 auto; padding: 1.5rem; }

        /* Tabs */
        .main-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-secondary);
            padding: 0.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .main-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .main-tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .main-tab.active { background: var(--accent-teal); color: white; }
        .tab-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.1rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
        }
        @media (max-width: 1200px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .card-title { font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .card-body { padding: 1.25rem; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--glow); }
        .stat-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .stat-card.peacock { border-color: var(--peacock); }
        .stat-card.peacock .stat-value { background: linear-gradient(135deg, var(--peacock), #0ea5e9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-card.tomato { border-color: var(--tomato); }
        .stat-card.tomato .stat-value { background: linear-gradient(135deg, var(--tomato), #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Projects List */
        .projects-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .project-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .project-item:hover { border-color: var(--accent-teal); transform: translateX(4px); }
        .project-item.active { border-color: var(--accent-teal); background: rgba(0,212,170,0.1); }
        .project-name { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .project-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .badge-active { background: rgba(34,197,94,0.2); color: var(--accent-green); }
        .badge-planning { background: rgba(59,130,246,0.2); color: var(--accent-blue); }

        /* Notes Section */
        .notes-panel { margin-bottom: 1.5rem; }
        .note-form {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        .note-form-row { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .note-input {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .note-input:focus { outline: none; border-color: var(--accent-teal); }
        .note-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
        }
        .note-textarea:focus { outline: none; border-color: var(--accent-teal); }
        .note-options { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .note-checkbox { display: flex; align-items: center; gap: 0.4rem; cursor: pointer; font-size: 0.85rem; }
        .note-checkbox input { accent-color: var(--accent-teal); }
        .note-select {
            padding: 0.5rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .notes-list { display: flex; flex-direction: column; gap: 0.75rem; max-height: 400px; overflow-y: auto; }
        .note-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.2s;
        }
        .note-item:hover { border-color: var(--accent-teal); }
        .note-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .note-title { font-weight: 600; font-size: 0.95rem; }
        .note-meta { font-size: 0.75rem; color: var(--text-muted); }
        .note-content { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .note-synced { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .sync-badge {
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: rgba(0,212,170,0.15);
            color: var(--accent-teal);
        }

        /* Staff Section */
        .staff-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
        .staff-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s;
        }
        .staff-card:hover { transform: translateY(-2px); box-shadow: var(--glow); }
        .staff-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .staff-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .staff-info { flex: 1; }
        .staff-name { font-weight: 600; font-size: 1rem; }
        .staff-role { font-size: 0.8rem; color: var(--text-secondary); }
        .staff-stats { display: flex; gap: 0.75rem; margin-top: 0.75rem; flex-wrap: wrap; }
        .staff-stat {
            padding: 0.4rem 0.75rem;
            background: var(--bg-primary);
            border-radius: 6px;
            font-size: 0.75rem;
        }
        .staff-stat.peacock-stat { border-left: 3px solid var(--peacock); }
        .staff-stat.tomato-stat { border-left: 3px solid var(--tomato); }
        .staff-projects { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .staff-projects-title { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .staff-project-list { display: flex; flex-wrap: wrap; gap: 0.4rem; }
        .staff-project-tag {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        /* Task List */
        .task-list { display: flex; flex-direction: column; gap: 0.5rem; max-height: 500px; overflow-y: auto; }
        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s;
        }
        .task-item:hover { border-color: var(--accent-teal); }
        .task-item.peacock-task { border-left: 4px solid var(--peacock); }
        .task-item.tomato-task { border-left: 4px solid var(--tomato); }
        .task-item.overdue { border-left: 4px solid var(--code-red); }
        .task-checkbox { accent-color: var(--accent-teal); margin-top: 3px; }
        .task-content { flex: 1; }
        .task-title { font-size: 0.9rem; font-weight: 500; }
        .task-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 0.25rem; }
        .task-priority { 
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }
        .priority-peacock { background: var(--peacock); color: white; }
        .priority-tomato { background: var(--tomato); color: white; }
        .priority-high { background: var(--accent-rose); color: white; }
        .priority-medium { background: var(--accent-amber); color: black; }

        /* Activity Feed */
        .activity-feed { max-height: 400px; overflow-y: auto; }
        .activity-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .activity-content { flex: 1; }
        .activity-text { font-size: 0.85rem; }
        .activity-time { font-size: 0.7rem; color: var(--text-muted); }

        /* CEO Report Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }
        .modal-title { font-weight: 700; font-size: 1.25rem; }
        .modal-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem; }
        .modal-body { padding: 1.5rem; }

        .report-section { margin-bottom: 2rem; }
        .report-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-teal);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table th, .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        .report-table th { background: var(--bg-tertiary); font-weight: 600; }
        .report-table tr:hover { background: rgba(0,212,170,0.05); }

        /* Settings Modal */
        .settings-section { margin-bottom: 1.5rem; }
        .settings-title { font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .settings-input-group { margin-bottom: 0.75rem; }
        .settings-label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .settings-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
        }
        .settings-input:focus { outline: none; border-color: var(--accent-teal); }

        /* Toast */
        .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast {
            padding: 1rem 1.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-color: var(--accent-green); }
        .toast.error { border-color: var(--accent-rose); }
        .toast.warning { border-color: var(--accent-amber); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-teal); }

        /* Links */
        a { color: var(--accent-teal); text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- Alert Banners Container -->
    <div class="alert-container" id="alertContainer">
        <!-- Alerts will be dynamically inserted here -->
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo">H&L WorkFlow</div>
                <div class="fy-badge">üìÖ FY2025 (Jul 2024 - Jun 2025)</div>
            </div>
            <div class="header-right">
                <div class="connection-pills">
                    <div class="conn-pill"><div class="conn-dot off" id="sb-dot"></div><span>Supabase</span></div>
                    <div class="conn-pill"><div class="conn-dot off" id="wr-dot"></div><span>Wrike</span></div>
                    <div class="conn-pill"><div class="conn-dot off" id="gc-dot"></div><span>Calendar</span></div>
                    <div class="conn-pill"><div class="conn-dot off" id="ch-dot"></div><span>Chat</span></div>
                </div>
                <button class="btn btn-ceo" onclick="generateCEOReport()">üìä CEO Weekly Update</button>
                <button class="btn btn-secondary" onclick="openSettings()">‚öôÔ∏è Settings</button>
                <button class="btn btn-primary" onclick="syncAll()">üîÑ Sync All</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Main Tabs -->
        <div class="main-tabs">
            <button class="main-tab active" data-tab="overview">üìä Overview</button>
            <button class="main-tab" data-tab="projects">üìÅ Projects <span class="tab-badge" id="project-count">0</span></button>
            <button class="main-tab" data-tab="staff">üë• Staff <span class="tab-badge" id="staff-count">0</span></button>
            <button class="main-tab" data-tab="priorities">üö® Priorities <span class="tab-badge" id="priority-count">0</span></button>
            <button class="main-tab" data-tab="notes">üìù Notes</button>
            <button class="main-tab" data-tab="activity">üìú Activity</button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="tab-overview">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card peacock">
                    <div class="stat-icon">üîµ</div>
                    <div class="stat-value" id="peacock-count">0</div>
                    <div class="stat-label">PEACOCK (Frozen/Stalled)</div>
                </div>
                <div class="stat-card tomato">
                    <div class="stat-icon">üî¥</div>
                    <div class="stat-value" id="tomato-count">0</div>
                    <div class="stat-label">TOMATO (Urgent)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-value" id="total-tasks">0</div>
                    <div class="stat-label">Active Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="total-staff">11</div>
                    <div class="stat-label">Team Members</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-value" id="overdue-count">0</div>
                    <div class="stat-label">Overdue Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="leads-count">0</div>
                    <div class="stat-label">Active Leads</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üö® Priority Tasks</div>
                        <button class="btn btn-secondary" onclick="refreshTasks()">‚Üª Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="task-list" id="priority-tasks">
                            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                Connect to view priority tasks...
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="card-header">
                            <div class="card-title">üìÅ Projects</div>
                        </div>
                        <div class="card-body">
                            <div class="projects-list" id="projects-list">
                                <div class="project-item active" data-project="dpc">
                                    <div class="project-name">üîß DPC Rust Conversion</div>
                                    <span class="project-badge badge-active">Active</span>
                                </div>
                                <!-- More projects will be loaded dynamically -->
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìÖ Upcoming Deadlines</div>
                        </div>
                        <div class="card-body">
                            <div id="upcoming-deadlines">
                                <div style="text-align: center; color: var(--text-muted); padding: 1rem;">
                                    Loading calendar...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div class="tab-content" id="tab-projects">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìÅ All Projects (FY2025)</div>
                    <button class="btn btn-primary" onclick="addProject()">+ Add Project</button>
                </div>
                <div class="card-body">
                    <div class="projects-list" id="all-projects-list">
                        <!-- Projects will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Staff Tab -->
        <div class="tab-content" id="tab-staff">
            <div class="staff-grid" id="staff-grid">
                <!-- Staff cards will be rendered here -->
            </div>
        </div>

        <!-- Priorities Tab -->
        <div class="tab-content" id="tab-priorities">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîµ PEACOCK Items (Frozen/Stalled)</div>
                </div>
                <div class="card-body">
                    <div class="task-list" id="peacock-list">
                        <!-- PEACOCK items -->
                    </div>
                </div>
            </div>
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">üî¥ TOMATO Items (Urgent)</div>
                </div>
                <div class="card-body">
                    <div class="task-list" id="tomato-list">
                        <!-- TOMATO items -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Tab -->
        <div class="tab-content" id="tab-notes">
            <div class="notes-panel">
                <div class="note-form">
                    <div class="note-form-row">
                        <input type="text" class="note-input" id="note-title" placeholder="Note title...">
                        <select class="note-select" id="note-project">
                            <option value="">Select Project</option>
                            <option value="dpc">DPC Rust Conversion</option>
                            <option value="general">General</option>
                        </select>
                        <select class="note-select" id="note-assignee">
                            <option value="">Assign to...</option>
                            <option value="DD">DD - David Dahm</option>
                            <option value="CM">CM - Christopher Mogg</option>
                            <option value="AP">AP - Alexander Pring</option>
                            <option value="RC">RC - Robert Cameron</option>
                            <option value="SA">SA - Shane Antonio</option>
                            <option value="MD">MD - Mary Duenas</option>
                            <option value="QN">QN - Quesie Norada</option>
                            <option value="AO">AO - Admin Officer</option>
                        </select>
                        <select class="note-select" id="note-priority">
                            <option value="normal">Normal Priority</option>
                            <option value="peacock">üîµ PEACOCK (Frozen)</option>
                            <option value="tomato">üî¥ TOMATO (Urgent)</option>
                            <option value="high">‚ö†Ô∏è High</option>
                        </select>
                    </div>
                    <textarea class="note-textarea" id="note-content" placeholder="Note content..."></textarea>
                    <div class="note-form-row" style="margin-top: 1rem;">
                        <div class="note-options">
                            <label class="note-checkbox"><input type="checkbox" id="sync-wrike" checked> Push to Wrike</label>
                            <label class="note-checkbox"><input type="checkbox" id="sync-calendar" checked> Add to Calendar</label>
                            <label class="note-checkbox"><input type="checkbox" id="sync-chat" checked> Post to Chat</label>
                        </div>
                        <input type="date" class="note-input" id="note-due" style="max-width: 180px;">
                        <button class="btn btn-primary" onclick="saveNote()">üíæ Save & Sync</button>
                    </div>
                </div>
                <div class="notes-list" id="notes-list">
                    <!-- Notes will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Activity Tab -->
        <div class="tab-content" id="tab-activity">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìú Activity Feed</div>
                    <button class="btn btn-secondary" onclick="clearActivity()">Clear</button>
                </div>
                <div class="card-body">
                    <div class="activity-feed" id="activity-feed">
                        <!-- Activity items -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CEO Report Modal -->
    <div class="modal-overlay" id="ceo-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìä Weekly CEO Update - <span id="report-date"></span></div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="downloadReport()">üì• Download</button>
                    <button class="btn btn-secondary" onclick="postToChat()">üí¨ Post to Chat</button>
                    <button class="modal-close" onclick="closeCEOModal()">√ó</button>
                </div>
            </div>
            <div class="modal-body" id="ceo-report-content">
                <!-- Report content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-title">üîå Supabase</div>
                    <div class="settings-input-group">
                        <label class="settings-label">Project URL</label>
                        <input type="text" class="settings-input" id="sb-url" value="https://ogvwqibfpvgdlqzyvyrk.supabase.co" readonly>
                    </div>
                    <div class="settings-input-group">
                        <label class="settings-label">Anon Key <a href="https://supabase.com/dashboard/project/ogvwqibfpvgdlqzyvyrk/settings/api" target="_blank">(Get Key)</a></label>
                        <input type="password" class="settings-input" id="sb-key" placeholder="eyJhbGciOiJIUzI1NiIs...">
                    </div>
                    <button class="btn btn-primary" onclick="connectSupabase()">Connect Supabase</button>
                </div>
                <div class="settings-section">
                    <div class="settings-title">üìã Wrike</div>
                    <div class="settings-input-group">
                        <label class="settings-label">API Token <a href="https://www.wrike.com/frontend/apps/index.html#/api" target="_blank">(Get Token)</a></label>
                        <input type="password" class="settings-input" id="wr-token" placeholder="Your Wrike access token">
                    </div>
                    <div class="settings-input-group">
                        <label class="settings-label">Folder ID</label>
                        <input type="text" class="settings-input" id="wr-folder" value="IEAAXVHEI4333116655">
                    </div>
                    <button class="btn btn-primary" onclick="connectWrike()">Connect Wrike</button>
                </div>
                <div class="settings-section">
                    <div class="settings-title">üìÖ Google Calendar</div>
                    <div class="settings-input-group">
                        <label class="settings-label">OAuth Client ID <a href="https://console.cloud.google.com/apis/credentials" target="_blank">(Create)</a></label>
                        <input type="text" class="settings-input" id="gc-client" placeholder="xxx.apps.googleusercontent.com">
                    </div>
                    <button class="btn btn-primary" onclick="connectCalendar()">Authorize Calendar</button>
                </div>
                <div class="settings-section">
                    <div class="settings-title">üí¨ Google Chat</div>
                    <div class="settings-input-group">
                        <label class="settings-label">Webhook URL</label>
                        <input type="text" class="settings-input" id="ch-webhook" placeholder="https://chat.googleapis.com/v1/spaces/...">
                    </div>
                    <button class="btn btn-primary" onclick="connectChat()">Test Chat Connection</button>
                </div>
                <div class="settings-section">
                    <div class="settings-title">üìä Control Spreadsheet</div>
                    <div class="settings-input-group">
                        <label class="settings-label">Google Sheet Link</label>
                        <input type="text" class="settings-input" id="control-sheet" value="https://docs.google.com/spreadsheets/d/1mcDGvJuHSO0TjORAplg7QothQc1wo8vKIjGW7JNoFbM/edit">
                    </div>
                    <a href="https://docs.google.com/spreadsheets/d/1mcDGvJuHSO0TjORAplg7QothQc1wo8vKIjGW7JNoFbM/edit" target="_blank" class="btn btn-secondary" style="display: inline-flex; margin-top: 0.5rem;">Open Control Sheet ‚Üó</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // Configuration
        const CONFIG = {
            supabase: { url: 'https://ogvwqibfpvgdlqzyvyrk.supabase.co', key: localStorage.getItem('sb_key') || '' },
            wrike: { token: localStorage.getItem('wr_token') || '', folder: localStorage.getItem('wr_folder') || 'IEAAXVHEI4333116655' },
            calendar: { clientId: localStorage.getItem('gc_client') || '', token: localStorage.getItem('gc_token') || '' },
            chat: { webhook: localStorage.getItem('ch_webhook') || '' },
            controlSheet: 'https://docs.google.com/spreadsheets/d/1mcDGvJuHSO0TjORAplg7QothQc1wo8vKIjGW7JNoFbM/edit'
        };

        // Staff data (from skill file)
        const STAFF = [
            { code: 'DD', name: 'David Dahm', role: 'CEO/Director', email: 'davidd@healthandlife.com.au', seniority: 1, slot: '1:00 AM' },
            { code: 'CM', name: 'Christopher Mogg', role: 'Lead Reviewer / Senior Accountant', email: 'christopherm@healthandlife.com.au', seniority: 2, slot: '2:00 AM' },
            { code: 'AP', name: 'Alexander Pring', role: 'P1 Senior Accountant', email: 'alexanderp@healthandlife.com.au', seniority: 3, slot: '3:00 AM' },
            { code: 'RC', name: 'Robert Cameron', role: 'P2 Senior / Admin Coordinator', email: 'robertc@healthandlife.com.au', seniority: 4, slot: '4:00 AM' },
            { code: 'SA', name: 'Shane Antonio', role: 'P3 Accountant', email: 'shanea@healthandlife.com.au', seniority: 5, slot: '5:00 AM' },
            { code: 'MD', name: 'Mary Duenas', role: 'P4 Bookkeeper', email: 'maryd@healthandlife.com.au', seniority: 6, slot: '6:00 AM' },
            { code: 'QN', name: 'Quesie Norada', role: 'P5 Junior', email: 'quesien@healthandlife.com.au', seniority: 7, slot: '7:00 AM' },
            { code: 'RM', name: 'Rodwen M', role: 'Admin Support', email: 'rodwenmc@healthandlife.com.au', seniority: 8, slot: '8:00 AM' },
            { code: 'NT', name: 'Nick Tsoulakis', role: 'Tech Reviews', email: 'nickt@healthandlife.com.au', seniority: 9, slot: 'Support' },
            { code: 'GS', name: 'Gurkirat Singh', role: 'ATO Sections', email: 'gurkirats@healthandlife.com.au', seniority: 10, slot: 'Support' },
            { code: 'AO', name: 'Admin Officer', role: 'Admin Officer', email: 'aoy@healthandlife.com.au', seniority: 11, slot: 'Support' }
        ];

        // Projects
        const PROJECTS = [
            { id: 'dpc', name: 'DPC Rust Conversion', status: 'active', lead: 'AO', team: ['AO', 'PE'], budget: '$10.6K-$13.1K', weeks: 16 },
            { id: 'general', name: 'General Operations', status: 'active', lead: 'DD', team: STAFF.map(s => s.code), budget: 'N/A', weeks: 0 }
        ];

        // State
        let state = {
            supabase: null,
            notes: JSON.parse(localStorage.getItem('workflow_notes') || '[]'),
            activities: JSON.parse(localStorage.getItem('workflow_activities') || '[]'),
            calendarEvents: [],
            wrikeTasks: [],
            alerts: { codeBlue: [], codeRed: [], peacock: [], tomato: [], leads: [], complaints: [] },
            connected: { sb: false, wr: false, gc: false, ch: false }
        };

        // Toast notification
        function toast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span><span>${message}</span>`;
            container.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        // Update connection status
        function updateDot(id, connected) {
            const dot = document.getElementById(id);
            dot.className = `conn-dot ${connected ? 'on' : 'off'}`;
        }

        // Tab switching
        document.querySelectorAll('.main-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
            });
        });

        // Connect Supabase
        async function connectSupabase() {
            const key = document.getElementById('sb-key').value;
            if (!key) { toast('Enter Supabase anon key', 'warning'); return; }
            try {
                state.supabase = supabase.createClient(CONFIG.supabase.url, key);
                localStorage.setItem('sb_key', key);
                CONFIG.supabase.key = key;
                state.connected.sb = true;
                updateDot('sb-dot', true);
                toast('Connected to Supabase!', 'success');
                logActivity('supabase', 'Connected to Supabase');
            } catch (e) {
                toast('Supabase connection failed', 'error');
            }
        }

        // Connect Wrike
        async function connectWrike() {
            const token = document.getElementById('wr-token').value;
            const folder = document.getElementById('wr-folder').value;
            if (!token) { toast('Enter Wrike token', 'warning'); return; }
            localStorage.setItem('wr_token', token);
            localStorage.setItem('wr_folder', folder);
            CONFIG.wrike.token = token;
            CONFIG.wrike.folder = folder;
            state.connected.wr = true;
            updateDot('wr-dot', true);
            toast('Wrike configured!', 'success');
            logActivity('wrike', 'Connected to Wrike');
            fetchWrikeTasks();
        }

        // Connect Calendar
        function connectCalendar() {
            const clientId = document.getElementById('gc-client').value;
            if (!clientId) { toast('Enter Google Client ID', 'warning'); return; }
            localStorage.setItem('gc_client', clientId);
            CONFIG.calendar.clientId = clientId;
            const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
            const scope = encodeURIComponent('https://www.googleapis.com/auth/calendar');
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}`;
            window.location.href = authUrl;
        }

        // Connect Chat
        async function connectChat() {
            const webhook = document.getElementById('ch-webhook').value;
            if (!webhook) { toast('Enter Chat webhook URL', 'warning'); return; }
            try {
                await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: 'üîî H&L WorkFlow Dashboard connected!' })
                });
                localStorage.setItem('ch_webhook', webhook);
                CONFIG.chat.webhook = webhook;
                state.connected.ch = true;
                updateDot('ch-dot', true);
                toast('Google Chat connected!', 'success');
                logActivity('chat', 'Connected to Google Chat');
            } catch (e) {
                toast('Chat connection failed', 'error');
            }
        }

        // Fetch Wrike tasks
        async function fetchWrikeTasks() {
            if (!CONFIG.wrike.token) return;
            try {
                const res = await fetch(`https://www.wrike.com/api/v4/folders/${CONFIG.wrike.folder}/tasks?status=Active`, {
                    headers: { 'Authorization': `Bearer ${CONFIG.wrike.token}` }
                });
                const data = await res.json();
                state.wrikeTasks = data.data || [];
                renderPriorityTasks();
                toast('Wrike tasks loaded', 'success');
            } catch (e) {
                console.error('Wrike fetch error:', e);
            }
        }

        // Save Note
        async function saveNote() {
            const title = document.getElementById('note-title').value;
            const content = document.getElementById('note-content').value;
            const project = document.getElementById('note-project').value;
            const assignee = document.getElementById('note-assignee').value;
            const priority = document.getElementById('note-priority').value;
            const due = document.getElementById('note-due').value;
            const syncWrike = document.getElementById('sync-wrike').checked;
            const syncCalendar = document.getElementById('sync-calendar').checked;
            const syncChat = document.getElementById('sync-chat').checked;

            if (!title) { toast('Enter a note title', 'warning'); return; }

            const note = {
                id: Date.now(),
                title, content, project, assignee, priority, due,
                synced: { wrike: false, calendar: false, chat: false },
                created: new Date().toISOString()
            };

            // Push to Wrike
            if (syncWrike && CONFIG.wrike.token) {
                try {
                    const res = await fetch(`https://www.wrike.com/api/v4/folders/${CONFIG.wrike.folder}/tasks`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${CONFIG.wrike.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: `[${assignee || 'Unassigned'}] ${title}`,
                            description: content,
                            dates: due ? { due: due } : undefined,
                            importance: priority === 'tomato' ? 'High' : priority === 'peacock' ? 'High' : 'Normal'
                        })
                    });
                    if (res.ok) {
                        note.synced.wrike = true;
                        logActivity('wrike', `Created task: ${title}`);
                    }
                } catch (e) { console.error('Wrike sync error:', e); }
            }

            // Push to Calendar
            if (syncCalendar && CONFIG.calendar.token && due) {
                try {
                    const event = {
                        summary: `[${assignee || 'Task'}] ${title}`,
                        description: content,
                        start: { date: due },
                        end: { date: due },
                        colorId: priority === 'peacock' ? '3' : priority === 'tomato' ? '11' : '7'
                    };
                    const res = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${CONFIG.calendar.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    });
                    if (res.ok) {
                        note.synced.calendar = true;
                        logActivity('calendar', `Created event: ${title}`);
                    }
                } catch (e) { console.error('Calendar sync error:', e); }
            }

            // Push to Chat
            if (syncChat && CONFIG.chat.webhook) {
                try {
                    const priorityEmoji = priority === 'peacock' ? 'üîµ' : priority === 'tomato' ? 'üî¥' : priority === 'high' ? '‚ö†Ô∏è' : 'üìù';
                    await fetch(CONFIG.chat.webhook, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cards: [{
                                header: {
                                    title: `${priorityEmoji} New Note: ${title}`,
                                    subtitle: `Assigned to: ${assignee || 'Unassigned'}`,
                                    imageUrl: 'https://www.gstatic.com/images/icons/material/system/2x/note_add_black_24dp.png'
                                },
                                sections: [{
                                    widgets: [
                                        { textParagraph: { text: content } },
                                        due ? { textParagraph: { text: `üìÖ Due: ${due}` } } : null
                                    ].filter(Boolean)
                                }]
                            }]
                        })
                    });
                    note.synced.chat = true;
                    logActivity('chat', `Posted note: ${title}`);
                } catch (e) { console.error('Chat sync error:', e); }
            }

            state.notes.unshift(note);
            localStorage.setItem('workflow_notes', JSON.stringify(state.notes));
            renderNotes();
            toast('Note saved and synced!', 'success');

            // Clear form
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            document.getElementById('note-due').value = '';
        }

        // Render Notes
        function renderNotes() {
            const container = document.getElementById('notes-list');
            if (state.notes.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No notes yet. Create one above!</div>';
                return;
            }
            container.innerHTML = state.notes.map(note => `
                <div class="note-item">
                    <div class="note-header">
                        <div class="note-title">${note.priority === 'peacock' ? 'üîµ' : note.priority === 'tomato' ? 'üî¥' : ''} ${note.title}</div>
                        <div class="note-meta">${new Date(note.created).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                    <div class="note-content">${note.content || 'No description'}</div>
                    <div class="note-synced">
                        ${note.synced.wrike ? '<span class="sync-badge">‚úì Wrike</span>' : ''}
                        ${note.synced.calendar ? '<span class="sync-badge">‚úì Calendar</span>' : ''}
                        ${note.synced.chat ? '<span class="sync-badge">‚úì Chat</span>' : ''}
                        ${note.assignee ? `<span class="sync-badge">üë§ ${note.assignee}</span>` : ''}
                        ${note.due ? `<span class="sync-badge">üìÖ ${note.due}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Render Priority Tasks
        function renderPriorityTasks() {
            const container = document.getElementById('priority-tasks');
            const tasks = state.wrikeTasks.slice(0, 20);
            if (tasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No tasks found</div>';
                return;
            }
            container.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox" ${task.status === 'Completed' ? 'checked' : ''}>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <span>üìÖ ${task.dates?.due || 'No due date'}</span>
                            <a href="https://www.wrike.com/open.htm?id=${task.id}" target="_blank">Open in Wrike ‚Üó</a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render Staff
        function renderStaff() {
            const container = document.getElementById('staff-grid');
            container.innerHTML = STAFF.map(staff => `
                <div class="staff-card">
                    <div class="staff-header">
                        <div class="staff-avatar">${staff.code}</div>
                        <div class="staff-info">
                            <div class="staff-name">${staff.name}</div>
                            <div class="staff-role">${staff.role}</div>
                        </div>
                    </div>
                    <div class="staff-stats">
                        <div class="staff-stat peacock-stat">0 Peacock</div>
                        <div class="staff-stat tomato-stat">0 Tomato</div>
                        <div class="staff-stat">0 Active</div>
                    </div>
                    <div class="staff-projects">
                        <div class="staff-projects-title">Assigned Projects</div>
                        <div class="staff-project-list">
                            ${PROJECTS.filter(p => p.team.includes(staff.code)).map(p => `<span class="staff-project-tag">${p.name}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('staff-count').textContent = STAFF.length;
        }

        // Render Alerts
        function renderAlerts() {
            const container = document.getElementById('alertContainer');
            container.innerHTML = '';
            
            // Sample alerts - in production these would come from calendar/Wrike analysis
            const alerts = [
                { type: 'code-blue', icon: 'üîµ', text: 'CODE BLUE: Critical system issues requiring immediate attention', count: 0, show: false },
                { type: 'code-red', icon: 'üî¥', text: 'CODE RED: Emergency items flagged for CEO review', count: 0, show: false },
                { type: 'peacock', icon: 'üßä', text: 'PEACOCK: Items frozen/stalled requiring unblocking', count: state.alerts.peacock.length, show: state.alerts.peacock.length > 0 },
                { type: 'tomato', icon: 'üçÖ', text: 'TOMATO: High priority urgent items due', count: state.alerts.tomato.length, show: state.alerts.tomato.length > 0 },
                { type: 'leads', icon: 'üìà', text: 'LEADS: New business opportunities to follow up', count: state.alerts.leads.length, show: state.alerts.leads.length > 0 },
                { type: 'complaints', icon: '‚ö†Ô∏è', text: 'COMPLAINTS: Client issues requiring resolution', count: state.alerts.complaints.length, show: state.alerts.complaints.length > 0 }
            ];

            alerts.filter(a => a.show).forEach(alert => {
                const div = document.createElement('div');
                div.className = `alert-banner alert-${alert.type}`;
                div.innerHTML = `
                    <span class="alert-icon">${alert.icon}</span>
                    <span class="alert-text">${alert.text}</span>
                    <span class="alert-count">${alert.count}</span>
                    <button class="alert-action" onclick="viewAlertDetails('${alert.type}')">View Details</button>
                `;
                container.appendChild(div);
            });
        }

        // Log activity
        function logActivity(source, message) {
            const activity = {
                id: Date.now(),
                source,
                message,
                time: new Date().toISOString()
            };
            state.activities.unshift(activity);
            if (state.activities.length > 100) state.activities = state.activities.slice(0, 100);
            localStorage.setItem('workflow_activities', JSON.stringify(state.activities));
            renderActivities();
        }

        // Render Activities
        function renderActivities() {
            const container = document.getElementById('activity-feed');
            container.innerHTML = state.activities.slice(0, 50).map(act => `
                <div class="activity-item">
                    <div class="activity-icon">
                        ${act.source === 'wrike' ? 'üìã' : act.source === 'calendar' ? 'üìÖ' : act.source === 'chat' ? 'üí¨' : act.source === 'supabase' ? 'üîå' : 'üìù'}
                    </div>
                    <div class="activity-content">
                        <div class="activity-text">${act.message}</div>
                        <div class="activity-time">${new Date(act.time).toLocaleString('en-AU')}</div>
                    </div>
                </div>
            `).join('');
        }

        // Generate CEO Weekly Update Report
        function generateCEOReport() {
            const modal = document.getElementById('ceo-modal');
            const reportContent = document.getElementById('ceo-report-content');
            const reportDate = document.getElementById('report-date');
            
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            reportDate.textContent = monday.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });

            reportContent.innerHTML = `
                <div class="report-section">
                    <div class="report-section-title">üìä Executive Summary</div>
                    <table class="report-table">
                        <tr><th>Metric</th><th>Count</th><th>Status</th></tr>
                        <tr><td>üîµ PEACOCK (Frozen/Stalled)</td><td>${state.alerts.peacock.length}</td><td>${state.alerts.peacock.length > 0 ? '‚ö†Ô∏è Requires Action' : '‚úÖ Clear'}</td></tr>
                        <tr><td>üî¥ TOMATO (Urgent)</td><td>${state.alerts.tomato.length}</td><td>${state.alerts.tomato.length > 0 ? '‚ö†Ô∏è Requires Action' : '‚úÖ Clear'}</td></tr>
                        <tr><td>üìà Active Leads</td><td>${state.alerts.leads.length}</td><td>üìä Tracking</td></tr>
                        <tr><td>‚ö†Ô∏è Complaints</td><td>${state.alerts.complaints.length}</td><td>${state.alerts.complaints.length > 0 ? 'üî¥ Attention Needed' : '‚úÖ Clear'}</td></tr>
                        <tr><td>üìã Active Tasks</td><td>${state.wrikeTasks.length}</td><td>üìä In Progress</td></tr>
                    </table>
                </div>

                <div class="report-section">
                    <div class="report-section-title">üîµ CODE BLUE Items</div>
                    <p style="color: var(--text-secondary);">No Code Blue alerts at this time.</p>
                </div>

                <div class="report-section">
                    <div class="report-section-title">üî¥ CODE RED Items</div>
                    <p style="color: var(--text-secondary);">No Code Red alerts at this time.</p>
                </div>

                <div class="report-section">
                    <div class="report-section-title">üìà Leads Status</div>
                    <table class="report-table">
                        <tr><th>Lead</th><th>Stage</th><th>Value</th><th>Next Action</th></tr>
                        <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">Connect to Control spreadsheet to view leads</td></tr>
                    </table>
                </div>

                <div class="report-section">
                    <div class="report-section-title">‚ö†Ô∏è Complaints</div>
                    <table class="report-table">
                        <tr><th>Client</th><th>Issue</th><th>Status</th><th>Assigned</th></tr>
                        <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No active complaints</td></tr>
                    </table>
                </div>

                <div class="report-section">
                    <div class="report-section-title">üë• Staff Workload (FY2025)</div>
                    <table class="report-table">
                        <tr><th>Staff</th><th>Role</th><th>Active Tasks</th><th>Peacock</th><th>Tomato</th></tr>
                        ${STAFF.map(s => `
                            <tr>
                                <td><strong>${s.code}</strong> - ${s.name}</td>
                                <td>${s.role}</td>
                                <td>-</td>
                                <td>0</td>
                                <td>0</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>

                <div class="report-section">
                    <div class="report-section-title">üìÅ Active Projects</div>
                    <table class="report-table">
                        <tr><th>Project</th><th>Status</th><th>Lead</th><th>Team</th><th>Budget</th></tr>
                        ${PROJECTS.map(p => `
                            <tr>
                                <td>${p.name}</td>
                                <td><span class="project-badge badge-${p.status}">${p.status}</span></td>
                                <td>${p.lead}</td>
                                <td>${p.team.join(', ')}</td>
                                <td>${p.budget}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>

                <div class="report-section">
                    <div class="report-section-title">üîó Quick Links</div>
                    <table class="report-table">
                        <tr><th>Resource</th><th>Link</th></tr>
                        <tr><td>üìä Control Spreadsheet</td><td><a href="${CONFIG.controlSheet}" target="_blank">Open Spreadsheet ‚Üó</a></td></tr>
                        <tr><td>üìã Wrike Project</td><td><a href="https://www.wrike.com/open.htm?id=4333116655" target="_blank">Open Wrike ‚Üó</a></td></tr>
                        <tr><td>üìÖ Google Calendar</td><td><a href="https://calendar.google.com/calendar/u/0/r/day" target="_blank">Open Calendar ‚Üó</a></td></tr>
                        <tr><td>üí¨ Google Chat</td><td><a href="https://mail.google.com/chat/u/0/#chat/home" target="_blank">Open Chat ‚Üó</a></td></tr>
                        <tr><td>üîå Supabase</td><td><a href="https://supabase.com/dashboard/project/ogvwqibfpvgdlqzyvyrk" target="_blank">Open Dashboard ‚Üó</a></td></tr>
                    </table>
                </div>

                <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                    <strong>Report Generated:</strong> ${new Date().toLocaleString('en-AU')}<br>
                    <strong>Financial Year:</strong> FY2025 (1 Jul 2024 - 30 Jun 2025)<br>
                    <strong>Report Period:</strong> Week of ${monday.toLocaleDateString('en-AU')}
                </div>
            `;

            modal.classList.add('active');
            logActivity('report', 'Generated CEO Weekly Update');
        }

        // Post report to Chat
        async function postToChat() {
            if (!CONFIG.chat.webhook) {
                toast('Configure Google Chat first', 'warning');
                return;
            }

            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);

            try {
                await fetch(CONFIG.chat.webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: `üìä *Weekly CEO Update - ${monday.toLocaleDateString('en-AU')}*

üîµ PEACOCK (Frozen): ${state.alerts.peacock.length} items
üî¥ TOMATO (Urgent): ${state.alerts.tomato.length} items
üìà Leads: ${state.alerts.leads.length}
‚ö†Ô∏è Complaints: ${state.alerts.complaints.length}

üë• Active Staff: ${STAFF.length}
üìÅ Active Projects: ${PROJECTS.length}

üìã Full report: https://softwarehealthandlife.github.io/doctors-pay-calculator/`
                    })
                });
                toast('Report posted to Google Chat!', 'success');
            } catch (e) {
                toast('Failed to post to Chat', 'error');
            }
        }

        // Download report as HTML
        function downloadReport() {
            const content = document.getElementById('ceo-report-content').innerHTML;
            const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>CEO Weekly Update</title>
<style>body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:2rem;background:#f5f5f5;}
table{width:100%;border-collapse:collapse;margin:1rem 0;}
th,td{padding:0.5rem;border:1px solid #ddd;text-align:left;}
th{background:#333;color:white;}</style></head>
<body>${content}</body></html>`;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CEO_Weekly_Update_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
            toast('Report downloaded!', 'success');
        }

        // Modal controls
        function closeCEOModal() { document.getElementById('ceo-modal').classList.remove('active'); }
        function openSettings() { document.getElementById('settings-modal').classList.add('active'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }

        // Sync all
        function syncAll() {
            toast('Syncing all services...', 'info');
            if (CONFIG.wrike.token) fetchWrikeTasks();
            logActivity('sync', 'Manual sync triggered');
            setTimeout(() => toast('Sync complete!', 'success'), 2000);
        }

        // Refresh tasks
        function refreshTasks() { fetchWrikeTasks(); }

        // Clear activity
        function clearActivity() {
            state.activities = [];
            localStorage.setItem('workflow_activities', '[]');
            renderActivities();
            toast('Activity cleared', 'success');
        }

        // View alert details
        function viewAlertDetails(type) {
            document.querySelector('[data-tab="priorities"]').click();
        }

        // Handle OAuth callback
        function handleOAuthCallback() {
            const hash = window.location.hash;
            if (hash.includes('access_token')) {
                const params = new URLSearchParams(hash.substring(1));
                const token = params.get('access_token');
                if (token) {
                    localStorage.setItem('gc_token', token);
                    CONFIG.calendar.token = token;
                    state.connected.gc = true;
                    updateDot('gc-dot', true);
                    toast('Google Calendar connected!', 'success');
                    logActivity('calendar', 'Connected to Google Calendar');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // Initialize
        function init() {
            handleOAuthCallback();
            
            // Load saved settings
            if (CONFIG.supabase.key) {
                document.getElementById('sb-key').value = CONFIG.supabase.key;
            }
            if (CONFIG.wrike.token) {
                document.getElementById('wr-token').value = CONFIG.wrike.token;
                state.connected.wr = true;
                updateDot('wr-dot', true);
            }
            if (CONFIG.calendar.token) {
                state.connected.gc = true;
                updateDot('gc-dot', true);
            }
            if (CONFIG.chat.webhook) {
                document.getElementById('ch-webhook').value = CONFIG.chat.webhook;
                state.connected.ch = true;
                updateDot('ch-dot', true);
            }

            // Render initial UI
            renderNotes();
            renderStaff();
            renderAlerts();
            renderActivities();
            
            // Update counts
            document.getElementById('project-count').textContent = PROJECTS.length;
            document.getElementById('total-staff').textContent = STAFF.length;

            // Auto-fetch if connected
            if (CONFIG.wrike.token) fetchWrikeTasks();

            logActivity('system', 'Dashboard initialized');
        }

        // Run on load
        init();
    </script>
</body>
</html>
