<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctors' Pay Calculator ‚Äì Project Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root{--bg:#0a0f1c;--bg2:#111827;--card:#1a2235;--card2:#212d45;--teal:#14b8a6;--violet:#8b5cf6;--amber:#f59e0b;--rose:#f43f5e;--blue:#3b82f6;--text:#f1f5f9;--text2:#94a3b8;--muted:#64748b;--border:#2d3a52;--success:#22c55e}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
        .container{max-width:1500px;margin:0 auto;padding:1.5rem}
        .integration-bar{display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1.5rem}
        .int-status{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:.5rem 1rem;display:flex;align-items:center;gap:.5rem;font-size:.85rem}
        .dot{width:8px;height:8px;border-radius:50%}
        .dot.on{background:var(--success);box-shadow:0 0 8px var(--success)}
        .dot.off{background:var(--muted)}
        .int-status a{color:var(--teal);text-decoration:none}
        header{margin-bottom:1.5rem}
        .header-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem;margin-bottom:1rem}
        .title-wrap{display:flex;align-items:center;gap:1rem}
        .icon{width:50px;height:50px;background:linear-gradient(135deg,var(--teal),#0d9488);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.3rem}
        h1{font-size:1.6rem;background:linear-gradient(135deg,var(--text),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .subtitle{color:var(--text2);font-size:.9rem}
        .actions{display:flex;gap:.5rem;flex-wrap:wrap}
        .btn{padding:.5rem 1rem;border-radius:8px;font-family:inherit;font-size:.8rem;font-weight:500;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:.4rem;text-decoration:none;transition:all .2s}
        .btn-p{background:linear-gradient(135deg,var(--teal),#0d9488);color:#fff}
        .btn-s{background:var(--bg2);border:1px solid var(--border);color:var(--text2)}
        .btn-v{background:linear-gradient(135deg,var(--violet),#7c3aed);color:#fff}
        .btn-b{background:linear-gradient(135deg,var(--blue),#2563eb);color:#fff}
        .btn-r{background:linear-gradient(135deg,var(--rose),#e11d48);color:#fff}
        .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.75rem;margin-bottom:1.5rem}
        .stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;display:flex;align-items:center;gap:.75rem}
        .stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center}
        .stat h3{font-size:1.1rem}
        .stat p{color:var(--text2);font-size:.75rem}
        .tabs{display:flex;gap:.25rem;border-bottom:1px solid var(--border);padding-bottom:.5rem;margin-bottom:1.5rem;overflow-x:auto}
        .tab{padding:.6rem 1rem;background:0;border:0;color:var(--text2);font-family:inherit;font-size:.85rem;cursor:pointer;border-radius:8px;white-space:nowrap}
        .tab:hover,.tab.active{color:var(--teal);background:rgba(20,184,166,.1)}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-bottom:1.5rem}
        .section-title{font-size:1.1rem;margin-bottom:1rem;display:flex;align-items:center;gap:.6rem}
        .sprint-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:1.25rem}
        .sprint{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
        .sprint-head{padding:1.25rem;border-bottom:1px solid var(--border)}
        .badge{font-family:'JetBrains Mono',monospace;font-size:.7rem;padding:.3rem .6rem;border-radius:16px;text-transform:uppercase}
        .b1{background:rgba(20,184,166,.15);color:var(--teal)}
        .b2{background:rgba(139,92,246,.15);color:var(--violet)}
        .b3{background:rgba(245,158,11,.15);color:var(--amber)}
        .b4{background:rgba(244,63,94,.15);color:var(--rose)}
        .sprint h3{font-size:1rem;margin-top:.5rem}
        .sprint-meta{color:var(--text2);font-size:.8rem;margin-top:.3rem}
        .sprint-dates{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--muted);background:var(--bg2);padding:.3rem .6rem;border-radius:6px;margin-top:.5rem;display:inline-block}
        .progress{padding:0 1.25rem;margin-top:.75rem}
        .progress-bar{height:5px;background:var(--bg2);border-radius:3px;overflow:hidden}
        .progress-fill{height:100%;border-radius:3px;transition:width .5s}
        .p1 .progress-fill{background:linear-gradient(135deg,var(--teal),#0d9488)}
        .p2 .progress-fill{background:linear-gradient(135deg,var(--violet),#7c3aed)}
        .p3 .progress-fill{background:linear-gradient(135deg,var(--amber),#d97706)}
        .p4 .progress-fill{background:linear-gradient(135deg,var(--rose),#e11d48)}
        .progress-label{display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-top:.4rem}
        .sprint-body{padding:1.25rem;max-height:350px;overflow-y:auto}
        .week{border:1px solid var(--border);border-radius:10px;margin-bottom:.6rem;overflow:hidden}
        .week-head{padding:.75rem 1rem;background:var(--bg2);cursor:pointer;display:flex;justify-content:space-between;align-items:center}
        .week-head:hover{background:var(--card2)}
        .week-title{font-weight:600;font-size:.9rem}
        .week-date{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--teal);background:rgba(20,184,166,.1);padding:.2rem .5rem;border-radius:4px;margin-left:.5rem}
        .week-toggle{color:var(--text2);transition:transform .3s;font-size:.8rem}
        .week.open .week-toggle{transform:rotate(180deg)}
        .week-content{max-height:0;overflow:hidden;transition:all .3s}
        .week.open .week-content{max-height:2000px;padding:1rem}
        .task-group{margin-bottom:1rem}
        .task-group:last-child{margin-bottom:0}
        .tg-title{font-size:.75rem;font-weight:600;text-transform:uppercase;margin-bottom:.5rem}
        .tg-ao{color:var(--teal)}
        .tg-pe{color:var(--violet)}
        .task{display:flex;align-items:flex-start;gap:.6rem;padding:.5rem 0;border-bottom:1px solid rgba(45,58,82,.4)}
        .task:last-child{border-bottom:0}
        .checkbox{width:18px;height:18px;border:2px solid var(--border);border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;transition:all .2s}
        .checkbox:hover{border-color:var(--teal)}
        .checkbox.checked{background:var(--teal);border-color:var(--teal)}
        .checkbox.checked::after{content:'‚úì';color:#fff;font-size:.7rem;font-weight:700}
        .task-text{font-size:.85rem;color:var(--text2);flex:1}
        .task.done .task-text{text-decoration:line-through;opacity:.5}
        .task-btns{display:flex;gap:.25rem;opacity:0;transition:opacity .2s}
        .task:hover .task-btns{opacity:1}
        .task-btn{background:0;border:0;color:var(--muted);cursor:pointer;padding:.2rem;font-size:.8rem}
        .task-btn:hover{color:var(--teal)}
        .team-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem}
        .team-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;text-align:center}
        .avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--teal),#0d9488);display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:700;margin:0 auto .75rem}
        .avatar.pe{background:linear-gradient(135deg,var(--violet),#7c3aed)}
        .team-name{font-weight:600}
        .team-role{color:var(--text2);font-size:.85rem}
        .team-email{color:var(--teal);font-size:.8rem;word-break:break-all;margin-top:.25rem}
        .activity-list{max-height:300px;overflow-y:auto}
        .activity{padding:.6rem;border-bottom:1px solid var(--border);display:flex;gap:.75rem;font-size:.85rem}
        .activity:last-child{border-bottom:0}
        .activity-time{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted);min-width:60px}
        .activity-user{color:var(--teal);font-weight:500}
        .delay{background:rgba(244,63,94,.08);border:1px solid rgba(244,63,94,.2);border-radius:10px;padding:1rem;margin-bottom:.75rem}
        .delay-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
        .delay-week{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--rose);font-weight:600}
        .delay-days{background:var(--rose);color:#fff;padding:.15rem .4rem;border-radius:4px;font-size:.7rem}
        .delay-reason{color:var(--text2);font-size:.85rem}
        .no-data{color:var(--muted);font-size:.85rem;text-align:center;padding:2rem;font-style:italic}
        .cal-event{background:var(--bg2);border-left:3px solid var(--blue);border-radius:8px;padding:.75rem 1rem;margin-bottom:.75rem}
        .cal-title{font-weight:600;font-size:.9rem}
        .cal-time{color:var(--text2);font-size:.8rem;font-family:'JetBrains Mono',monospace}
        table{width:100%;border-collapse:collapse;font-size:.85rem}
        th,td{text-align:left;padding:.85rem 1rem;border-bottom:1px solid var(--border)}
        th{background:var(--bg2);font-weight:600;color:var(--text2);text-transform:uppercase;font-size:.7rem}
        .highlight{color:var(--teal);font-weight:600}
        .modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s}
        .modal-bg.active{opacity:1;visibility:visible}
        .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;width:95%;max-width:550px;max-height:90vh;overflow-y:auto}
        .modal-title{font-size:1.1rem;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
        .form-group{margin-bottom:1rem}
        .form-group label{display:block;font-size:.85rem;color:var(--text2);margin-bottom:.4rem}
        .form-group input,.form-group select,.form-group textarea{width:100%;background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:.65rem .85rem;border-radius:8px;font-family:inherit;font-size:.9rem}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:0;border-color:var(--teal)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
        .modal-actions{display:flex;gap:.75rem;margin-top:1rem}
        .setup-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
        .setup-card{background:var(--bg2);border-radius:12px;padding:1.25rem}
        .setup-card h3{font-size:1rem;margin-bottom:.5rem}
        .setup-card p{font-size:.8rem;color:var(--text2);margin-bottom:1rem}
        .setup-link{color:var(--teal);font-size:.8rem}
        .toast{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--teal);color:var(--text);padding:.85rem 1.25rem;border-radius:10px;font-size:.9rem;z-index:2000;opacity:0;visibility:hidden;transition:all .3s}
        .toast.show{opacity:1;visibility:visible}
        .toast.error{border-color:var(--rose)}
        .toast.success{border-color:var(--success)}
        @media(max-width:768px){.container{padding:1rem}.sprint-grid{grid-template-columns:1fr}.stats{grid-template-columns:repeat(2,1fr)}.form-row{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="container">
    <div class="integration-bar">
        <div class="int-status"><span class="dot" id="sb-dot"></span>Supabase <a href="https://supabase.com/dashboard/project/ogvwqibfpvgdlqzyvyrk" target="_blank">Dashboard</a></div>
        <div class="int-status"><span class="dot" id="wr-dot"></span>Wrike <a href="https://www.wrike.com/open.htm?id=4333116655" target="_blank">Project</a></div>
        <div class="int-status"><span class="dot" id="gc-dot"></span>Calendar <a href="https://calendar.google.com/calendar/u/0/r/day" target="_blank">Open</a></div>
        <div class="int-status"><span class="dot on"></span>GitHub <a href="https://github.com/SoftwareHealthAndLife/doctors-pay-calculator" target="_blank">Repo</a></div>
    </div>

    <header>
        <div class="header-top">
            <div class="title-wrap">
                <div class="icon">üí∞</div>
                <div><h1>Doctors' Pay Calculator</h1><p class="subtitle">Rust Web Rebuild ‚Äì Live Dashboard</p></div>
            </div>
            <div class="actions">
                <input type="date" id="start-date" value="2025-01-06" style="background:var(--card);border:1px solid var(--border);color:var(--text);padding:.5rem;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:.8rem">
                <button class="btn btn-s" id="setup-btn">‚öôÔ∏è Setup</button>
                <button class="btn btn-b" id="gcal-btn">üìÖ Calendar</button>
                <button class="btn btn-v" id="wrike-btn">üìã Wrike</button>
                <button class="btn btn-p" id="refresh-btn">üîÑ Refresh</button>
            </div>
        </div>
        <div class="stats">
            <div class="stat"><div class="stat-icon" style="background:rgba(20,184,166,.15);color:var(--teal)">üìÖ</div><div><h3>16</h3><p>Weeks</p></div></div>
            <div class="stat"><div class="stat-icon" style="background:rgba(139,92,246,.15);color:var(--violet)">üìã</div><div><h3 id="total-t">62</h3><p>Tasks</p></div></div>
            <div class="stat"><div class="stat-icon" style="background:rgba(34,197,94,.15);color:var(--success)">‚úÖ</div><div><h3 id="done-pct">0%</h3><p>Done</p></div></div>
            <div class="stat"><div class="stat-icon" style="background:rgba(245,158,11,.15);color:var(--amber)">üíµ</div><div><h3>$10.6-13K</h3><p>Budget</p></div></div>
            <div class="stat"><div class="stat-icon" style="background:rgba(244,63,94,.15);color:var(--rose)">‚ö†Ô∏è</div><div><h3 id="delay-d">0</h3><p>Delay Days</p></div></div>
            <div class="stat"><div class="stat-icon" style="background:rgba(59,130,246,.15);color:var(--blue)">üë•</div><div><h3 id="team-n">2</h3><p>Team</p></div></div>
        </div>
    </header>

    <nav class="tabs">
        <button class="tab active" data-tab="sprints">üèÉ Sprints</button>
        <button class="tab" data-tab="team">üë• Team</button>
        <button class="tab" data-tab="calendar">üìÖ Calendar</button>
        <button class="tab" data-tab="activity">üìú Activity</button>
        <button class="tab" data-tab="delays">‚ö†Ô∏è Delays</button>
        <button class="tab" data-tab="summary">üìä Summary</button>
    </nav>

    <div id="sprints" class="tab-content active"><div class="sprint-grid" id="sprint-grid"></div></div>
    
    <div id="team" class="tab-content">
        <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem">
                <h2 class="section-title" style="margin:0">üë• Project Team</h2>
                <button class="btn btn-p" id="add-member-btn">+ Add Member</button>
            </div>
            <div class="team-grid" id="team-grid"></div>
        </div>
    </div>

    <div id="calendar" class="tab-content">
        <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem">
                <h2 class="section-title" style="margin:0">üìÖ Calendar Events</h2>
                <div style="display:flex;gap:.5rem">
                    <button class="btn btn-b" id="gcal-auth-btn">üîê Connect Google</button>
                    <button class="btn btn-p" id="push-cal-btn">üì§ Push to Calendar</button>
                </div>
            </div>
            <div id="cal-events"><div class="no-data">Connect Google Calendar to see events and push deadlines.</div></div>
        </div>
    </div>

    <div id="activity" class="tab-content">
        <div class="section">
            <h2 class="section-title">üìú Real-time Activity</h2>
            <div class="activity-list" id="activity-list"><div class="no-data">Connect Supabase to see real-time activity.</div></div>
        </div>
    </div>

    <div id="delays" class="tab-content">
        <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem">
                <h2 class="section-title" style="margin:0">‚ö†Ô∏è Delay Log</h2>
                <button class="btn btn-r" id="add-delay-btn">+ Log Delay</button>
            </div>
            <div id="delay-list"><div class="no-data">No delays recorded.</div></div>
        </div>
    </div>

    <div id="summary" class="tab-content">
        <div class="section">
            <h2 class="section-title">üìä Sprint Summary</h2>
            <table><thead><tr><th>Sprint</th><th>Weeks</th><th>Focus</th><th>Progress</th></tr></thead><tbody id="sum-tbody"></tbody></table>
        </div>
        <div class="section">
            <h2 class="section-title">üí∞ Budget</h2>
            <table><thead><tr><th>Category</th><th>Item</th><th>Cost (AUD)</th></tr></thead><tbody>
                <tr><td>Labour</td><td>260-320 hrs @ $40/hr</td><td class="highlight">$10,400‚Äì12,800</td></tr>
                <tr><td>Software</td><td>Claude, Supabase, Hosting, Monitoring</td><td>~$270</td></tr>
                <tr style="background:var(--bg2)"><td colspan="2"><strong>TOTAL</strong></td><td class="highlight"><strong>$10,600‚Äì13,100</strong></td></tr>
            </tbody></table>
        </div>
    </div>
</div>

<!-- Setup Modal -->
<div class="modal-bg" id="setup-modal">
    <div class="modal">
        <h3 class="modal-title">‚öôÔ∏è Integration Setup</h3>
        <div class="setup-grid">
            <div class="setup-card">
                <h3>üîå Supabase</h3>
                <p>Real-time sync for tasks, comments, team.</p>
                <div class="form-group"><label>URL</label><input type="text" id="sb-url" value="https://ogvwqibfpvgdlqzyvyrk.supabase.co" readonly style="opacity:.7"></div>
                <div class="form-group"><label>Anon Key <a href="https://supabase.com/dashboard/project/ogvwqibfpvgdlqzyvyrk/settings/api-keys" target="_blank" class="setup-link">(Get ‚Üí)</a></label><input type="password" id="sb-key" placeholder="Paste key..."></div>
                <button class="btn btn-p" id="connect-sb">Connect</button>
            </div>
            <div class="setup-card">
                <h3>üìã Wrike</h3>
                <p>Sync tasks & comments with Wrike.</p>
                <div class="form-group"><label>Token <a href="https://www.wrike.com/frontend/apps/index.html#/api" target="_blank" class="setup-link">(Get ‚Üí)</a></label><input type="password" id="wr-token" placeholder="Paste token..."></div>
                <div class="form-group"><label>Folder ID</label><input type="text" id="wr-folder" value="IEAAXVHEI4333116655"></div>
                <button class="btn btn-v" id="connect-wr">Connect</button>
            </div>
            <div class="setup-card">
                <h3>üìÖ Google Calendar</h3>
                <p>Push deadlines to team calendars.</p>
                <div class="form-group"><label>Client ID <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="setup-link">(Create ‚Üí)</a></label><input type="text" id="gc-client" placeholder="xxx.apps.googleusercontent.com"></div>
                <button class="btn btn-b" id="connect-gc">Authorize</button>
            </div>
        </div>
        <div class="form-group" style="margin-top:1rem"><label>Your Name</label><input type="text" id="user-name" placeholder="AO or PE"></div>
        <div class="form-group"><label>Your Email</label><input type="email" id="user-email" placeholder="you@email.com"></div>
        <div class="modal-actions"><button class="btn btn-s" id="close-setup">Close</button><button class="btn btn-p" id="save-setup">Save</button></div>
    </div>
</div>

<!-- Delay Modal -->
<div class="modal-bg" id="delay-modal">
    <div class="modal">
        <h3 class="modal-title">‚ö†Ô∏è Log Delay</h3>
        <form id="delay-form">
            <div class="form-row">
                <div class="form-group"><label>Week</label><select id="d-week"></select></div>
                <div class="form-group"><label>Days</label><input type="number" id="d-days" min="1" max="30" value="1" required></div>
            </div>
            <div class="form-group"><label>Category</label><select id="d-cat"><option value="resource">Resource</option><option value="technical">Technical</option><option value="external">External</option><option value="scope">Scope</option><option value="data">Data</option></select></div>
            <div class="form-group"><label>Reason</label><textarea id="d-reason" rows="2" required></textarea></div>
            <div class="form-group"><label>Impact</label><textarea id="d-impact" rows="2"></textarea></div>
            <div class="modal-actions"><button type="button" class="btn btn-s" id="cancel-delay">Cancel</button><button type="submit" class="btn btn-r">Log</button></div>
        </form>
    </div>
</div>

<!-- Member Modal -->
<div class="modal-bg" id="member-modal">
    <div class="modal">
        <h3 class="modal-title">üë§ Add Team Member</h3>
        <form id="member-form">
            <div class="form-group"><label>Name</label><input type="text" id="m-name" required></div>
            <div class="form-group"><label>Role</label><select id="m-role"><option value="Project Lead">AO - Project Lead</option><option value="Developer">PE - Developer</option><option value="Other">Other</option></select></div>
            <div class="form-group"><label>Email</label><input type="email" id="m-email" required></div>
            <div class="form-group"><label>Days</label><input type="text" id="m-days" placeholder="Mon, Wed, Thu, Fri"></div>
            <div class="modal-actions"><button type="button" class="btn btn-s" id="cancel-member">Cancel</button><button type="submit" class="btn btn-p">Add</button></div>
        </form>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const P={
    sprints:[{id:1,name:'Setup, Discovery & Data Model',weeks:'1-4',effort:'50-70 hrs'},{id:2,name:'Rust Backend & Core APIs',weeks:'5-8',effort:'95-115 hrs'},{id:3,name:'Front End & Integration',weeks:'9-12',effort:'75-90 hrs'},{id:4,name:'CI/CD, Migration & Go-Live',weeks:'13-16',effort:'60-70 hrs'}],
    tasks:[
        {s:1,w:1,a:'PE',t:'Create accounts: GitHub, Supabase, Vercel, Fly.io, Wrike, Claude'},{s:1,w:1,a:'PE',t:'Set up GitHub repos (backend, frontend, migrations)'},{s:1,w:1,a:'PE',t:'Set up Wrike project structure'},{s:1,w:1,a:'AO',t:'Confirm scope with stakeholders'},{s:1,w:1,a:'AO',t:'Review old calculator, list key modules'},
        {s:1,w:2,a:'PE',t:'Export FileMaker tables to CSV/PDF'},{s:1,w:2,a:'PE',t:'Organise exports, link to Wrike'},{s:1,w:2,a:'AO',t:'Turn scripts to pseudocode with Claude'},{s:1,w:2,a:'AO',t:'Define entities (doctors, sessions, fees)'},
        {s:1,w:3,a:'PE',t:'Draft Postgres schema in Supabase'},{s:1,w:3,a:'PE',t:'Create ERD'},{s:1,w:3,a:'AO',t:'Review schema with Claude'},{s:1,w:3,a:'AO',t:'Plan tax year versioning'},
        {s:1,w:4,a:'PE',t:'Implement schema & constraints'},{s:1,w:4,a:'PE',t:'Smoke-test queries'},{s:1,w:4,a:'AO',t:'Sign off schema milestone'},
        {s:2,w:5,a:'PE',t:'Install Rust, set up backend repo'},{s:2,w:5,a:'PE',t:'Add routing & health endpoint'},{s:2,w:5,a:'AO',t:'Define API design in Wrike'},{s:2,w:5,a:'AO',t:'Draft Rust module structure'},
        {s:2,w:6,a:'PE',t:'Integrate SQLx with Supabase'},{s:2,w:6,a:'PE',t:'Add logging middleware'},{s:2,w:6,a:'AO',t:'Set up GitHub Actions'},{s:2,w:6,a:'AO',t:'Write unit tests'},
        {s:2,w:7,a:'PE',t:'Implement core calculations'},{s:2,w:7,a:'PE',t:'Convert pseudocode to Rust'},{s:2,w:7,a:'AO',t:'Implement /calculate-pay endpoint'},{s:2,w:7,a:'AO',t:'Define test scenarios'},
        {s:2,w:8,a:'PE',t:'Implement /tax-year endpoint'},{s:2,w:8,a:'PE',t:'Build integration tests'},{s:2,w:8,a:'AO',t:'Validate against FileMaker'},{s:2,w:8,a:'AO',t:'Mark Core APIs milestone'},
        {s:3,w:9,a:'PE',t:'Scaffold Next.js app'},{s:3,w:9,a:'PE',t:'Connect GitHub + Vercel'},{s:3,w:9,a:'AO',t:'Design pages with Claude'},{s:3,w:9,a:'AO',t:'Create frontend tasks in Wrike'},
        {s:3,w:10,a:'PE',t:'Build calculator form'},{s:3,w:10,a:'PE',t:'Wire to API'},{s:3,w:10,a:'AO',t:'Add Tailwind styling'},{s:3,w:10,a:'AO',t:'Test E2E, log bugs'},
        {s:3,w:11,a:'PE',t:'Build results page'},{s:3,w:11,a:'PE',t:'Add admin pages'},{s:3,w:11,a:'AO',t:'Polish UX with Claude'},{s:3,w:11,a:'AO',t:'Browser testing'},
        {s:3,w:12,a:'PE',t:'Fix bugs, access control'},{s:3,w:12,a:'PE',t:'Optimise performance'},{s:3,w:12,a:'AO',t:'Sign off MVP UI'},
        {s:4,w:13,a:'PE',t:'Extend CI/CD for frontend'},{s:4,w:13,a:'PE',t:'Set up Fly.io hosting'},{s:4,w:13,a:'AO',t:'Verify staging'},{s:4,w:13,a:'AO',t:'Enable Supabase Pro'},
        {s:4,w:14,a:'PE',t:'Review DB performance'},{s:4,w:14,a:'PE',t:'Set up Grafana monitoring'},{s:4,w:14,a:'AO',t:'Define cutover plan'},
        {s:4,w:15,a:'PE',t:'Export FileMaker data, write imports'},{s:4,w:15,a:'PE',t:'Validate data'},{s:4,w:15,a:'AO',t:'Run parallel operation'},
        {s:4,w:16,a:'PE',t:'Final fixes & validation'},{s:4,w:16,a:'PE',t:'Execute final import'},{s:4,w:16,a:'AO',t:'Production cutover'},{s:4,w:16,a:'AO',t:'Write release notes'}
    ],
    team:[{name:'AO',role:'Project Lead',email:'',days:'Thu, Fri'},{name:'PE',role:'Developer',email:'',days:'Mon, Wed, Thu, Fri'}]
};

let S={tasks:new Array(P.tasks.length).fill(false),delays:[],activities:[],team:[...P.team],startDate:'2025-01-06',userName:'',userEmail:'',sb:null,wrToken:'',wrFolder:'IEAAXVHEI4333116655',gcClient:'',gcToken:null,conn:{sb:false,wr:false,gc:false}};

function toast(m,t=''){const e=document.getElementById('toast');e.textContent=m;e.className='toast show '+t;setTimeout(()=>e.classList.remove('show'),3500)}
function fmtDate(d){return new Date(d).toLocaleDateString('en-AU',{day:'numeric',month:'short'})}
function fmtTime(d){return new Date(d).toLocaleString('en-AU',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}
function dot(id,on){document.getElementById(id).className='dot '+(on?'on':'off')}

async function connectSB(){
    const k=document.getElementById('sb-key').value;
    if(!k){toast('Enter Supabase key','error');return}
    try{
        S.sb=supabase.createClient('https://ogvwqibfpvgdlqzyvyrk.supabase.co',k);
        await S.sb.from('tasks').select('count');
        localStorage.setItem('sbKey',k);
        S.conn.sb=true;dot('sb-dot',true);
        toast('Connected to Supabase!','success');
        await loadSB();setupRT();logAct('connected','Joined dashboard');
    }catch(e){dot('sb-dot',false);toast('Connection failed: '+e.message,'error')}
}

async function loadSB(){
    if(!S.sb)return;
    const{data:t}=await S.sb.from('tasks').select('*');
    if(t)t.forEach(x=>{if(x.task_index<S.tasks.length)S.tasks[x.task_index]=x.completed});
    const{data:d}=await S.sb.from('delays').select('*').order('created_at',{ascending:false});
    if(d)S.delays=d;
    const{data:a}=await S.sb.from('activity').select('*').order('created_at',{ascending:false}).limit(50);
    if(a)S.activities=a;
    const{data:m}=await S.sb.from('team').select('*');
    if(m&&m.length)S.team=m;
    renderAll();
}

function setupRT(){
    if(!S.sb)return;
    S.sb.channel('all').on('postgres_changes',{event:'*',schema:'public',table:'tasks'},p=>{if(p.new){S.tasks[p.new.task_index]=p.new.completed;renderSprints();updateStats()}})
    .on('postgres_changes',{event:'*',schema:'public',table:'delays'},async()=>{const{data}=await S.sb.from('delays').select('*').order('created_at',{ascending:false});if(data)S.delays=data;renderDelays();updateStats()})
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'activity'},p=>{if(p.new){S.activities.unshift(p.new);renderActivity()}})
    .on('postgres_changes',{event:'*',schema:'public',table:'team'},async()=>{const{data}=await S.sb.from('team').select('*');if(data)S.team=data;renderTeam()})
    .subscribe();
}

async function syncTask(i,done){if(!S.sb)return;await S.sb.from('tasks').upsert({task_index:i,completed:done,completed_by:S.userName,completed_at:done?new Date().toISOString():null},{onConflict:'task_index'});logAct(done?'completed':'uncompleted',`Task: "${P.tasks[i].t.substring(0,40)}..."`)}
async function logAct(a,d){if(!S.sb)return;await S.sb.from('activity').insert({user_name:S.userName||'Anon',action:a,details:d})}

function connectWR(){
    const t=document.getElementById('wr-token').value,f=document.getElementById('wr-folder').value;
    if(!t){toast('Enter Wrike token','error');return}
    S.wrToken=t;S.wrFolder=f;localStorage.setItem('wrToken',t);localStorage.setItem('wrFolder',f);
    S.conn.wr=true;dot('wr-dot',true);toast('Wrike configured!','success');
}

async function pushToWrike(i){
    if(!S.wrToken){toast('Configure Wrike first','error');return}
    const t=P.tasks[i];
    try{
        await fetch(`https://www.wrike.com/api/v4/folders/${S.wrFolder}/tasks`,{method:'POST',headers:{'Authorization':'Bearer '+S.wrToken,'Content-Type':'application/json'},body:JSON.stringify({title:`[S${t.s}W${t.w}] ${t.t.substring(0,80)}`,description:`Sprint ${t.s}, Week ${t.w}\nAssignee: ${t.a}\n\n${t.t}`,status:S.tasks[i]?'Completed':'Active'})});
        toast('Pushed to Wrike!','success');logAct('wrike','Pushed task '+i);
    }catch(e){toast('Wrike push failed','error')}
}

function authGCal(){
    const c=document.getElementById('gc-client').value;
    if(!c){toast('Enter Google Client ID','error');return}
    S.gcClient=c;localStorage.setItem('gcClient',c);
    google.accounts.oauth2.initTokenClient({client_id:c,scope:'https://www.googleapis.com/auth/calendar',callback:r=>{if(r.access_token){S.gcToken=r.access_token;S.conn.gc=true;dot('gc-dot',true);toast('Google Calendar connected!','success');loadCalEvents()}}}).requestAccessToken({prompt:'consent'});
}

async function loadCalEvents(){
    if(!S.gcToken)return;
    try{
        const r=await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?maxResults=15&orderBy=startTime&singleEvents=true&timeMin=${new Date().toISOString()}`,{headers:{'Authorization':'Bearer '+S.gcToken}});
        const d=await r.json();
        if(d.items)renderCalEvents(d.items);
    }catch(e){console.error(e)}
}

async function pushAllToCal(){
    if(!S.gcToken){toast('Connect Google Calendar first','error');return}
    toast('Pushing deadlines to calendar...');
    for(let w=1;w<=16;w++){
        const tasks=P.tasks.filter(t=>t.w===w);
        if(!tasks.length)continue;
        const sd=new Date(S.startDate);sd.setDate(sd.getDate()+(w-1)*7+4);
        const evt={summary:`[DPC] Week ${w} Deadline`,description:`Tasks:\n${tasks.map(t=>`- [${t.a}] ${t.t}`).join('\n')}`,start:{date:sd.toISOString().split('T')[0]},end:{date:sd.toISOString().split('T')[0]},attendees:S.team.filter(m=>m.email).map(m=>({email:m.email}))};
        await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events?sendUpdates=all',{method:'POST',headers:{'Authorization':'Bearer '+S.gcToken,'Content-Type':'application/json'},body:JSON.stringify(evt)});
        await new Promise(r=>setTimeout(r,300));
    }
    toast('All deadlines pushed!','success');loadCalEvents();
}

function renderAll(){renderSprints();renderTeam();renderActivity();renderDelays();renderSummary();updateStats();updateDates()}

function renderSprints(){
    document.getElementById('sprint-grid').innerHTML=P.sprints.map(sp=>{
        const ts=P.tasks.filter(t=>t.s===sp.id),ws=[...new Set(ts.map(t=>t.w))],done=ts.filter(t=>S.tasks[P.tasks.indexOf(t)]).length,pct=Math.round(done/ts.length*100);
        return `<div class="sprint p${sp.id}"><div class="sprint-head"><span class="badge b${sp.id}">Sprint ${sp.id}</span><h3>${sp.name}</h3><div class="sprint-meta">üìÜ Weeks ${sp.weeks} ‚Ä¢ ‚è±Ô∏è ${sp.effort}</div><div class="sprint-dates" data-sp="${sp.id}"></div></div><div class="progress"><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div><div class="progress-label"><span>${done}/${ts.length}</span><span>${pct}%</span></div></div><div class="sprint-body">${ws.map(w=>renderWeek(sp.id,w)).join('')}</div></div>`;
    }).join('');
    document.querySelectorAll('.week-head').forEach(h=>h.onclick=()=>h.parentElement.classList.toggle('open'));
    document.querySelectorAll('.checkbox').forEach(c=>c.onclick=()=>toggleTask(+c.dataset.i));
    document.querySelectorAll('.task-wr').forEach(b=>b.onclick=e=>{e.stopPropagation();pushToWrike(+b.dataset.i)});
    updateDates();
}

function renderWeek(sp,w){
    const ts=P.tasks.filter(t=>t.s===sp&&t.w===w),ao=ts.filter(t=>t.a==='AO'),pe=ts.filter(t=>t.a==='PE');
    return `<div class="week"><div class="week-head"><div><span class="week-title">Week ${w}</span><span class="week-date" data-w="${w}"></span></div><span class="week-toggle">‚ñº</span></div><div class="week-content">${pe.length?`<div class="task-group"><div class="tg-title tg-pe">üë®‚Äçüíª PE</div>${pe.map(t=>renderTask(t)).join('')}</div>`:''} ${ao.length?`<div class="task-group"><div class="tg-title tg-ao">üëî AO</div>${ao.map(t=>renderTask(t)).join('')}</div>`:''}</div></div>`;
}

function renderTask(t){
    const i=P.tasks.indexOf(t),d=S.tasks[i];
    return `<div class="task ${d?'done':''}"><div class="checkbox ${d?'checked':''}" data-i="${i}"></div><span class="task-text">${t.t}</span><div class="task-btns"><button class="task-btn task-wr" data-i="${i}" title="Push to Wrike">üìã</button></div></div>`;
}

function toggleTask(i){S.tasks[i]=!S.tasks[i];renderSprints();updateStats();saveLocal();if(S.conn.sb)syncTask(i,S.tasks[i])}

function renderTeam(){
    document.getElementById('team-grid').innerHTML=S.team.map(m=>`<div class="team-card"><div class="avatar ${m.role==='Developer'?'pe':''}">${m.name.charAt(0)}</div><div class="team-name">${m.name}</div><div class="team-role">${m.role}</div>${m.email?`<div class="team-email">${m.email}</div>`:''}<div style="color:var(--muted);font-size:.8rem;margin-top:.25rem">üìÖ ${m.days||'N/A'}</div></div>`).join('');
    document.getElementById('team-n').textContent=S.team.length;
}

function renderCalEvents(evts){
    if(!evts||!evts.length){document.getElementById('cal-events').innerHTML='<div class="no-data">No upcoming events.</div>';return}
    document.getElementById('cal-events').innerHTML=evts.slice(0,10).map(e=>`<div class="cal-event"><div class="cal-title">${e.summary}</div><div class="cal-time">${e.start.dateTime?fmtTime(e.start.dateTime):e.start.date}</div></div>`).join('');
}

function renderActivity(){
    if(!S.activities.length){document.getElementById('activity-list').innerHTML='<div class="no-data">No activity yet.</div>';return}
    document.getElementById('activity-list').innerHTML=S.activities.slice(0,30).map(a=>`<div class="activity"><span class="activity-time">${fmtTime(a.created_at)}</span><span><span class="activity-user">${a.user_name}</span> ${a.action}: ${a.details||''}</span></div>`).join('');
}

function renderDelays(){
    if(!S.delays.length){document.getElementById('delay-list').innerHTML='<div class="no-data">No delays recorded.</div>';return}
    document.getElementById('delay-list').innerHTML=S.delays.map(d=>`<div class="delay"><div class="delay-head"><span class="delay-week">Week ${d.week} ‚Ä¢ ${d.category}</span><span class="delay-days">+${d.days} day${d.days>1?'s':''}</span></div><div class="delay-reason">${d.reason}</div></div>`).join('');
}

function renderSummary(){
    const b=['b1','b2','b3','b4'];
    document.getElementById('sum-tbody').innerHTML=P.sprints.map((sp,i)=>{
        const ts=P.tasks.filter(t=>t.s===sp.id),done=ts.filter(t=>S.tasks[P.tasks.indexOf(t)]).length,pct=Math.round(done/ts.length*100);
        return `<tr><td><span class="badge ${b[i]}">Sprint ${sp.id}</span></td><td>${sp.weeks}</td><td>${sp.name}</td><td class="highlight">${pct}%</td></tr>`;
    }).join('');
}

function updateStats(){
    const done=S.tasks.filter(Boolean).length,total=S.tasks.length;
    document.getElementById('total-t').textContent=total;
    document.getElementById('done-pct').textContent=Math.round(done/total*100)+'%';
    document.getElementById('delay-d').textContent=S.delays.reduce((s,d)=>s+(d.days||0),0);
}

function updateDates(){
    const sd=new Date(S.startDate);
    document.querySelectorAll('[data-w]').forEach(e=>{const w=+e.dataset.w-1,ws=new Date(sd);ws.setDate(sd.getDate()+w*7);const we=new Date(ws);we.setDate(ws.getDate()+4);e.textContent=`${fmtDate(ws)}‚Äì${fmtDate(we)}`});
    const r=[[0,3],[4,7],[8,11],[12,15]];
    document.querySelectorAll('[data-sp]').forEach(e=>{const s=+e.dataset.sp-1,[sw,ew]=r[s],ss=new Date(sd);ss.setDate(sd.getDate()+sw*7);const se=new Date(sd);se.setDate(sd.getDate()+ew*7+4);e.textContent=`${fmtDate(ss)} ‚Äì ${fmtDate(se)} ${se.getFullYear()}`});
}

function saveLocal(){localStorage.setItem('dpcS',JSON.stringify({tasks:S.tasks,delays:S.delays,startDate:S.startDate,userName:S.userName,userEmail:S.userEmail,team:S.team}))}
function loadLocal(){
    const s=localStorage.getItem('dpcS');if(s){const d=JSON.parse(s);S.tasks=d.tasks||S.tasks;S.delays=d.delays||[];S.startDate=d.startDate||S.startDate;S.userName=d.userName||'';S.userEmail=d.userEmail||'';if(d.team)S.team=d.team}
    S.wrToken=localStorage.getItem('wrToken')||'';S.wrFolder=localStorage.getItem('wrFolder')||'IEAAXVHEI4333116655';S.gcClient=localStorage.getItem('gcClient')||'';
    document.getElementById('sb-key').value=localStorage.getItem('sbKey')||'';
    document.getElementById('wr-token').value=S.wrToken;document.getElementById('wr-folder').value=S.wrFolder;
    document.getElementById('gc-client').value=S.gcClient;
    document.getElementById('user-name').value=S.userName;document.getElementById('user-email').value=S.userEmail;
    document.getElementById('start-date').value=S.startDate;
}

document.addEventListener('DOMContentLoaded',()=>{
    const ws=document.getElementById('d-week');for(let i=1;i<=16;i++)ws.innerHTML+=`<option value="${i}">Week ${i}</option>`;
    loadLocal();renderAll();
    if(localStorage.getItem('sbKey'))connectSB();
    if(S.wrToken){S.conn.wr=true;dot('wr-dot',true)}
});

document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById(t.dataset.tab).classList.add('active')});

document.getElementById('setup-btn').onclick=()=>document.getElementById('setup-modal').classList.add('active');
document.getElementById('close-setup').onclick=()=>document.getElementById('setup-modal').classList.remove('active');
document.getElementById('connect-sb').onclick=connectSB;
document.getElementById('connect-wr').onclick=connectWR;
document.getElementById('connect-gc').onclick=authGCal;
document.getElementById('gcal-auth-btn').onclick=authGCal;
document.getElementById('push-cal-btn').onclick=pushAllToCal;
document.getElementById('save-setup').onclick=()=>{S.userName=document.getElementById('user-name').value;S.userEmail=document.getElementById('user-email').value;S.startDate=document.getElementById('start-date').value;saveLocal();updateDates();toast('Saved!','success');document.getElementById('setup-modal').classList.remove('active')};
document.getElementById('start-date').onchange=e=>{S.startDate=e.target.value;updateDates();saveLocal()};
document.getElementById('refresh-btn').onclick=()=>{if(S.conn.sb)loadSB();else renderAll();toast('Refreshed!','success')};
document.getElementById('gcal-btn').onclick=()=>{if(S.conn.gc)loadCalEvents();else document.getElementById('setup-modal').classList.add('active')};
document.getElementById('wrike-btn').onclick=()=>window.open('https://www.wrike.com/open.htm?id=4333116655','_blank');

document.getElementById('add-delay-btn').onclick=()=>document.getElementById('delay-modal').classList.add('active');
document.getElementById('cancel-delay').onclick=()=>document.getElementById('delay-modal').classList.remove('active');
document.getElementById('delay-form').onsubmit=async e=>{
    e.preventDefault();
    const d={week:+document.getElementById('d-week').value,days:+document.getElementById('d-days').value,category:document.getElementById('d-cat').value,reason:document.getElementById('d-reason').value,impact:document.getElementById('d-impact').value,created_by:S.userName};
    S.delays.unshift(d);if(S.sb)await S.sb.from('delays').insert(d);
    renderDelays();updateStats();saveLocal();
    document.getElementById('delay-modal').classList.remove('active');document.getElementById('delay-form').reset();
    toast('Delay logged!','success');logAct('delay',`+${d.days} days Week ${d.week}`);
};

document.getElementById('add-member-btn').onclick=()=>document.getElementById('member-modal').classList.add('active');
document.getElementById('cancel-member').onclick=()=>document.getElementById('member-modal').classList.remove('active');
document.getElementById('member-form').onsubmit=async e=>{
    e.preventDefault();
    const m={name:document.getElementById('m-name').value,role:document.getElementById('m-role').value,email:document.getElementById('m-email').value,days:document.getElementById('m-days').value};
    S.team.push(m);if(S.sb)await S.sb.from('team').insert(m);
    renderTeam();saveLocal();
    document.getElementById('member-modal').classList.remove('active');document.getElementById('member-form').reset();
    toast('Member added!','success');logAct('team','Added '+m.name);
};
</script>
</body>
</html>
