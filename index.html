<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctors' Pay Calculator ‚Äì Project Plan (Collaborative)</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-card-hover: #212d45;
            --accent-teal: #14b8a6;
            --accent-teal-light: #2dd4bf;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-violet: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d3a52;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --gradient-teal: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            --gradient-violet: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            --gradient-amber: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-rose: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.6; }
        .bg-pattern { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.4; background: radial-gradient(ellipse at 20% 20%, rgba(20, 184, 166, 0.08) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.06) 0%, transparent 50%); }
        .container { position: relative; z-index: 1; max-width: 1600px; margin: 0 auto; padding: 2rem; }
        
        /* Connection Status Banner */
        .connection-banner { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .connection-status { display: flex; align-items: center; gap: 0.75rem; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.connected { background: var(--success); box-shadow: 0 0 10px var(--success); animation: pulse 2s infinite; }
        .status-dot.disconnected { background: var(--danger); }
        .status-dot.connecting { background: var(--warning); animation: blink 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .status-text { font-size: 0.9rem; color: var(--text-secondary); }
        .status-text strong { color: var(--text-primary); }
        .connection-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        
        /* Setup Panel */
        .setup-panel { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; }
        .setup-panel h2 { font-size: 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; }
        .setup-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .setup-section { background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; }
        .setup-section h3 { font-size: 1rem; margin-bottom: 1rem; color: var(--accent-teal); }
        .setup-section p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .setup-section code { background: var(--bg-primary); padding: 0.2rem 0.5rem; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; }
        
        /* Form Elements */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea { width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 8px; font-family: inherit; font-size: 0.9rem; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-teal); }
        
        /* Buttons */
        .btn { padding: 0.6rem 1.2rem; border-radius: 8px; font-family: inherit; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border: none; }
        .btn-primary { background: var(--gradient-teal); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3); }
        .btn-secondary { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-secondary:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .btn-violet { background: var(--gradient-violet); color: white; }
        .btn-violet:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .btn-amber { background: var(--gradient-amber); color: white; }
        .btn-amber:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
        .btn-rose { background: var(--gradient-rose); color: white; }
        .btn-rose:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        
        /* Header */
        header { margin-bottom: 2rem; }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1.5rem; }
        .project-title { display: flex; align-items: center; gap: 1rem; }
        .project-icon { width: 56px; height: 56px; background: var(--gradient-teal); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 8px 32px rgba(20, 184, 166, 0.3); }
        h1 { font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-teal-light) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .project-subtitle { color: var(--text-secondary); font-size: 0.95rem; margin-top: 0.25rem; }
        .header-controls { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; }
        .header-controls input[type="date"] { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.5rem 0.75rem; border-radius: 8px; font-family: 'JetBrains Mono', monospace; }
        
        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 1rem 1.25rem; display: flex; align-items: center; gap: 0.75rem; }
        .stat-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .stat-icon.teal { background: rgba(20, 184, 166, 0.15); color: var(--accent-teal); }
        .stat-icon.violet { background: rgba(139, 92, 246, 0.15); color: var(--accent-violet); }
        .stat-icon.amber { background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); }
        .stat-icon.rose { background: rgba(244, 63, 94, 0.15); color: var(--accent-rose); }
        .stat-icon.green { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .stat-content h3 { font-size: 1.25rem; font-weight: 700; line-height: 1.2; }
        .stat-content p { color: var(--text-secondary); font-size: 0.8rem; }
        
        /* Tabs */
        .nav-tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; overflow-x: auto; }
        .nav-tab { padding: 0.75rem 1.5rem; background: transparent; border: none; color: var(--text-secondary); font-family: inherit; font-size: 0.95rem; font-weight: 500; cursor: pointer; border-radius: 8px; transition: all 0.2s ease; white-space: nowrap; }
        .nav-tab:hover { color: var(--text-primary); background: var(--bg-card); }
        .nav-tab.active { color: var(--accent-teal); background: rgba(20, 184, 166, 0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Sprint Cards */
        .sprint-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 1.5rem; }
        .sprint-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; overflow: hidden; }
        .sprint-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .sprint-number { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 500; padding: 0.35rem 0.75rem; border-radius: 20px; text-transform: uppercase; }
        .sprint-1 .sprint-number { background: rgba(20, 184, 166, 0.15); color: var(--accent-teal); }
        .sprint-2 .sprint-number { background: rgba(139, 92, 246, 0.15); color: var(--accent-violet); }
        .sprint-3 .sprint-number { background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); }
        .sprint-4 .sprint-number { background: rgba(244, 63, 94, 0.15); color: var(--accent-rose); }
        .sprint-title { font-size: 1.1rem; font-weight: 600; margin-top: 0.75rem; }
        .sprint-meta { display: flex; gap: 1rem; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.85rem; flex-wrap: wrap; }
        .sprint-dates { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-muted); background: var(--bg-secondary); padding: 0.4rem 0.75rem; border-radius: 8px; margin-top: 0.75rem; display: inline-block; }
        .sprint-progress { padding: 0 1.5rem; margin-top: 1rem; }
        .progress-bar { height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .sprint-1 .progress-fill { background: var(--gradient-teal); }
        .sprint-2 .progress-fill { background: var(--gradient-violet); }
        .sprint-3 .progress-fill { background: var(--gradient-amber); }
        .sprint-4 .progress-fill { background: var(--gradient-rose); }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; }
        .sprint-body { padding: 1.5rem; }
        
        /* Week Accordion */
        .week-accordion { border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 0.75rem; overflow: hidden; }
        .week-header { padding: 1rem 1.25rem; background: var(--bg-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .week-header:hover { background: var(--bg-card-hover); }
        .week-header-left { display: flex; align-items: center; gap: 0.75rem; }
        .week-title { font-weight: 600; font-size: 0.95rem; }
        .week-date { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent-teal); background: rgba(20, 184, 166, 0.1); padding: 0.25rem 0.6rem; border-radius: 6px; }
        .week-toggle { color: var(--text-secondary); transition: transform 0.3s ease; }
        .week-accordion.open .week-toggle { transform: rotate(180deg); }
        .week-content { padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; }
        .week-accordion.open .week-content { padding: 1.25rem; max-height: 2000px; }
        
        /* Tasks */
        .task-group { margin-bottom: 1.25rem; }
        .task-group:last-child { margin-bottom: 0; }
        .task-group-title { font-size: 0.8rem; font-weight: 600; color: var(--accent-teal); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; }
        .task-group-title.pe { color: var(--accent-violet); }
        .task-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.6rem 0; border-bottom: 1px solid rgba(45, 58, 82, 0.5); }
        .task-item:last-child { border-bottom: none; }
        .task-checkbox { width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: all 0.2s ease; }
        .task-checkbox:hover { border-color: var(--accent-teal); }
        .task-checkbox.checked { background: var(--accent-teal); border-color: var(--accent-teal); }
        .task-checkbox.checked::after { content: '‚úì'; color: white; font-size: 0.75rem; font-weight: 700; }
        .task-checkbox.syncing { border-color: var(--warning); animation: blink 0.5s infinite; }
        .task-text { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; }
        .task-item.completed .task-text { text-decoration: line-through; opacity: 0.6; }
        
        /* Delays */
        .delay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .delay-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .delay-item { background: rgba(244, 63, 94, 0.08); border: 1px solid rgba(244, 63, 94, 0.2); border-radius: 10px; padding: 1rem; position: relative; }
        .delay-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem; }
        .delay-week { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent-rose); font-weight: 600; }
        .delay-days { background: var(--accent-rose); color: white; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .delay-reason { color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; }
        .delay-impact { margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); font-style: italic; }
        .delay-category { font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-left: 0.5rem; }
        .remove-delay-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; opacity: 0; transition: opacity 0.2s ease; }
        .delay-item:hover .remove-delay-btn { opacity: 1; }
        .no-delays { color: var(--text-muted); font-size: 0.85rem; font-style: italic; text-align: center; padding: 2rem; }
        
        /* Summary Section */
        .summary-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; padding: 2rem; margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .section-title-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-secondary); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.75rem; }
        th:first-child { border-radius: 10px 0 0 0; }
        th:last-child { border-radius: 0 10px 0 0; }
        tr:last-child td { border-bottom: none; }
        .table-highlight { color: var(--accent-teal); font-weight: 600; }
        .badge { display: inline-block; padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .badge-teal { background: rgba(20, 184, 166, 0.15); color: var(--accent-teal); }
        .badge-violet { background: rgba(139, 92, 246, 0.15); color: var(--accent-violet); }
        .badge-amber { background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); }
        .badge-rose { background: rgba(244, 63, 94, 0.15); color: var(--accent-rose); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; padding: 2rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
        
        /* Toast */
        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--accent-teal); color: var(--text-primary); padding: 1rem 1.5rem; border-radius: 12px; font-size: 0.9rem; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .toast.show { opacity: 1; visibility: visible; }
        .toast.error { border-color: var(--accent-rose); }
        .toast.success { border-color: var(--success); }
        
        /* Wrike Export Preview */
        .wrike-preview { background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; margin-top: 1rem; max-height: 300px; overflow-y: auto; }
        .wrike-preview pre { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-secondary); white-space: pre-wrap; }
        
        /* Activity Log */
        .activity-log { max-height: 300px; overflow-y: auto; }
        .activity-item { padding: 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 0.75rem; align-items: flex-start; }
        .activity-item:last-child { border-bottom: none; }
        .activity-time { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; }
        .activity-text { font-size: 0.85rem; color: var(--text-secondary); }
        .activity-user { color: var(--accent-teal); font-weight: 500; }
        
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            h1 { font-size: 1.5rem; }
            .sprint-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .setup-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    <div class="container">
        <!-- Connection Status Banner -->
        <div class="connection-banner">
            <div class="connection-status">
                <div class="status-dot disconnected" id="status-dot"></div>
                <span class="status-text" id="status-text">Not connected ‚Äì <strong>Offline Mode</strong></span>
            </div>
            <div class="connection-actions">
                <a href="https://github.com/SoftwareHealthAndLife/doctors-pay-calculator" target="_blank" class="btn btn-secondary btn-sm">üìÇ GitHub Repo</a>
                <button class="btn btn-secondary btn-sm" id="setup-btn">‚öôÔ∏è Setup</button>
                <button class="btn btn-violet btn-sm" id="wrike-export-btn" disabled>üì§ Export to Wrike</button>
                <button class="btn btn-primary btn-sm" id="sync-btn" disabled>üîÑ Sync Now</button>
            </div>
        </div>

        <header>
            <div class="header-top">
                <div class="project-title">
                    <div class="project-icon">üí∞</div>
                    <div>
                        <h1>Doctors' Pay Calculator</h1>
                        <p class="project-subtitle">Rust Web Rebuild ‚Äì Live Collaborative Project Plan</p>
                    </div>
                </div>
                <div class="header-controls">
                    <label style="color: var(--text-secondary); font-size: 0.9rem;">Start Date:</label>
                    <input type="date" id="start-date" value="2025-01-06">
                    <button class="btn btn-primary btn-sm" id="update-dates-btn">Update Dates</button>
                </div>
            </div>
            <div class="stats-row">
                <div class="stat-card"><div class="stat-icon teal">üìÖ</div><div class="stat-content"><h3>16 Weeks</h3><p>Duration</p></div></div>
                <div class="stat-card"><div class="stat-icon violet">‚è±Ô∏è</div><div class="stat-content"><h3>260‚Äì320 hrs</h3><p>Total Effort</p></div></div>
                <div class="stat-card"><div class="stat-icon amber">üíµ</div><div class="stat-content"><h3>$10.6‚Äì13.1K</h3><p>Budget (AUD)</p></div></div>
                <div class="stat-card"><div class="stat-icon green">‚úÖ</div><div class="stat-content"><h3 id="completed-stat">0%</h3><p>Completed</p></div></div>
                <div class="stat-card"><div class="stat-icon rose">‚ö†Ô∏è</div><div class="stat-content"><h3 id="delay-stat">0 days</h3><p>Total Delays</p></div></div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="sprints">Sprint Overview</button>
            <button class="nav-tab" data-tab="delays">Delays & Risks</button>
            <button class="nav-tab" data-tab="activity">Activity Log</button>
            <button class="nav-tab" data-tab="summary">Summary</button>
        </nav>

        <!-- Sprint Overview Tab -->
        <div id="sprints" class="tab-content active">
            <div class="sprint-grid" id="sprint-container">
                <!-- Sprints will be generated by JavaScript -->
            </div>
        </div>

        <!-- Delays Tab -->
        <div id="delays" class="tab-content">
            <div class="summary-section">
                <div class="delay-header">
                    <h2 class="section-title"><span class="section-title-icon" style="background: rgba(244, 63, 94, 0.15); color: var(--accent-rose);">‚ö†Ô∏è</span>Delay Log</h2>
                    <button class="btn btn-rose btn-sm" id="add-delay-btn">+ Add Delay</button>
                </div>
                <div class="delay-list" id="delay-list">
                    <div class="no-delays">No delays recorded yet.</div>
                </div>
            </div>
        </div>

        <!-- Activity Log Tab -->
        <div id="activity" class="tab-content">
            <div class="summary-section">
                <h2 class="section-title"><span class="section-title-icon" style="background: rgba(139, 92, 246, 0.15); color: var(--accent-violet);">üìú</span>Real-time Activity Log</h2>
                <div class="activity-log" id="activity-log">
                    <div class="no-delays">No activity yet. Connect to Supabase to see real-time updates.</div>
                </div>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="summary" class="tab-content">
            <div class="summary-section">
                <h2 class="section-title"><span class="section-title-icon" style="background: rgba(20, 184, 166, 0.15); color: var(--accent-teal);">üìä</span>Sprint Summary</h2>
                <table>
                    <thead><tr><th>Sprint</th><th>Weeks</th><th>Dates</th><th>Focus</th><th>Progress</th></tr></thead>
                    <tbody id="summary-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div class="modal-overlay" id="setup-modal">
        <div class="modal">
            <h3 class="modal-title">‚öôÔ∏è Integration Setup</h3>
            <div class="setup-grid">
                <div class="setup-section">
                    <h3>üîå Supabase (Real-time Sync)</h3>
                    <p>Connect to Supabase for real-time collaboration. All team members will see updates instantly.</p>
                    <div class="form-group">
                        <label>Supabase URL</label>
                        <input type="text" id="supabase-url" placeholder="https://xxxxx.supabase.co" value="https://ogvwqibfpvgdlqzyvyrk.supabase.co" readonly style="opacity:0.8;">
                    </div>
                    <div class="form-group">
                        <label>Anon Key <a href="https://supabase.com/dashboard/project/ogvwqibfpvgdlqzyvyrk/settings/api-keys" target="_blank" style="color: var(--accent-teal); font-size: 0.8rem;">(Get from Supabase ‚Üí)</a></label>
                        <input type="password" id="supabase-key" placeholder="Paste your anon public key here...">
                    </div>
                    <button class="btn btn-primary" id="connect-supabase-btn">Connect to Supabase</button>
                    <p style="margin-top: 1rem; font-size: 0.8rem;">
                        <strong>‚úÖ Database Ready!</strong> Tables already created in your Supabase project.
                        <br><a href="https://supabase.com/dashboard/project/ogvwqibfpvgdlqzyvyrk" target="_blank" style="color: var(--accent-teal);">Open Supabase Dashboard</a>
                    </p>
                </div>
                <div class="setup-section">
                    <h3>üìã Wrike (Export Tasks)</h3>
                    <p>Export tasks to Wrike for project management integration.</p>
                    <div class="form-group">
                        <label>Wrike Access Token</label>
                        <input type="password" id="wrike-token" placeholder="Your Wrike permanent token">
                    </div>
                    <div class="form-group">
                        <label>Wrike Folder ID (optional)</label>
                        <input type="text" id="wrike-folder" placeholder="IEAXXXXX">
                    </div>
                    <button class="btn btn-violet" id="save-wrike-btn">Save Wrike Settings</button>
                    <p style="margin-top: 1rem; font-size: 0.8rem;">
                        Get your token from Wrike ‚Üí Apps & Integrations ‚Üí API ‚Üí Create App ‚Üí Permanent Token
                    </p>
                </div>
            </div>
            <div class="form-group" style="margin-top: 1.5rem;">
                <label>Your Name (for activity log)</label>
                <input type="text" id="user-name" placeholder="e.g., AO or PE">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="close-setup-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Schema Modal -->
    <div class="modal-overlay" id="schema-modal">
        <div class="modal">
            <h3 class="modal-title">üìÑ Supabase SQL Schema</h3>
            <p style="margin-bottom: 1rem; color: var(--text-secondary);">Run this SQL in your Supabase SQL Editor to create the required tables:</p>
            <div class="wrike-preview">
                <pre id="schema-sql">-- Tasks table
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    task_index INTEGER NOT NULL UNIQUE,
    completed BOOLEAN DEFAULT FALSE,
    completed_by TEXT,
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable real-time
ALTER PUBLICATION supabase_realtime ADD TABLE tasks;

-- Delays table  
CREATE TABLE delays (
    id SERIAL PRIMARY KEY,
    week INTEGER NOT NULL,
    days INTEGER NOT NULL,
    category TEXT NOT NULL,
    reason TEXT NOT NULL,
    impact TEXT,
    created_by TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER PUBLICATION supabase_realtime ADD TABLE delays;

-- Activity log
CREATE TABLE activity (
    id SERIAL PRIMARY KEY,
    user_name TEXT NOT NULL,
    action TEXT NOT NULL,
    details TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER PUBLICATION supabase_realtime ADD TABLE activity;

-- Project settings
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Row Level Security (optional but recommended)
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE delays ENABLE ROW LEVEL SECURITY;
ALTER TABLE activity ENABLE ROW LEVEL SECURITY;
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;

-- Allow all operations for now (customize as needed)
CREATE POLICY "Allow all" ON tasks FOR ALL USING (true);
CREATE POLICY "Allow all" ON delays FOR ALL USING (true);
CREATE POLICY "Allow all" ON activity FOR ALL USING (true);
CREATE POLICY "Allow all" ON settings FOR ALL USING (true);</pre>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="copy-schema-btn">üìã Copy SQL</button>
                <button class="btn btn-secondary" id="close-schema-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Delay Modal -->
    <div class="modal-overlay" id="delay-modal">
        <div class="modal">
            <h3 class="modal-title">‚ö†Ô∏è Log Delay</h3>
            <form id="delay-form">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group"><label>Affected Week</label><select id="delay-week" required style="width:100%;padding:0.75rem;background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary);border-radius:8px;"><option value="">Select...</option>${[...Array(16)].map((_,i)=>`<option value="${i+1}">Week ${i+1}</option>`).join('')}</select></div>
                    <div class="form-group"><label>Delay (days)</label><input type="number" id="delay-days" min="1" max="30" value="1" required></div>
                </div>
                <div class="form-group"><label>Category</label><select id="delay-category" required style="width:100%;padding:0.75rem;background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary);border-radius:8px;"><option value="resource">Resource</option><option value="technical">Technical</option><option value="external">External</option><option value="scope">Scope</option><option value="data">Data</option><option value="environment">Environment</option></select></div>
                <div class="form-group"><label>Reason</label><textarea id="delay-reason" rows="3" required></textarea></div>
                <div class="form-group"><label>Impact / Mitigation</label><textarea id="delay-impact" rows="2"></textarea></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary" id="cancel-delay-btn">Cancel</button><button type="submit" class="btn btn-rose">Log Delay</button></div>
            </form>
        </div>
    </div>

    <!-- Wrike Export Modal -->
    <div class="modal-overlay" id="wrike-modal">
        <div class="modal">
            <h3 class="modal-title">üì§ Export to Wrike</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">This will create tasks in your Wrike workspace. Preview the export below:</p>
            <div class="wrike-preview" id="wrike-preview"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-wrike-btn">Cancel</button>
                <button class="btn btn-violet" id="confirm-wrike-btn">Export to Wrike</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ==================== DATA ====================
        const PROJECT_DATA = {
            sprints: [
                { id: 1, name: 'Setup, Discovery & Data Model', weeks: '1‚Äì4', effort: '50‚Äì70 hrs', cost: '$2,000‚Äì2,800', milestone: 'Schema complete' },
                { id: 2, name: 'Rust Backend Foundation & Core APIs', weeks: '5‚Äì8', effort: '95‚Äì115 hrs', cost: '$3,800‚Äì4,600', milestone: 'Core APIs usable' },
                { id: 3, name: 'Front End & Integration', weeks: '9‚Äì12', effort: '75‚Äì90 hrs', cost: '$3,000‚Äì3,600', milestone: 'MVP UI complete' },
                { id: 4, name: 'CI/CD, Hosting, Migration & Go-Live', weeks: '13‚Äì16', effort: '60‚Äì70 hrs', cost: '$2,400‚Äì2,800', milestone: 'Production cutover' }
            ],
            tasks: [
                // Sprint 1
                { sprint: 1, week: 1, assignee: 'PE', text: 'Create accounts: GitHub, Supabase, Vercel, Fly.io/Render, Wrike, Google Workspace, Claude; set up password manager' },
                { sprint: 1, week: 1, assignee: 'PE', text: 'Set up GitHub org and initial repos (backend, frontend, db-migrations)' },
                { sprint: 1, week: 1, assignee: 'PE', text: 'Set up Wrike project structure and main milestones in Google Calendar' },
                { sprint: 1, week: 1, assignee: 'AO', text: 'Confirm scope and success criteria with stakeholders' },
                { sprint: 1, week: 1, assignee: 'AO', text: 'Review the old doctors\' pay calculator (high-level) and list key modules in Wrike' },
                { sprint: 1, week: 2, assignee: 'PE', text: 'Export FileMaker/BetterForms tables, fields, scripts, and layouts to CSV/PDF' },
                { sprint: 1, week: 2, assignee: 'PE', text: 'Organise exports into shared folders and link them into Wrike tasks' },
                { sprint: 1, week: 2, assignee: 'AO', text: 'With Claude, turn key FileMaker scripts into pseudocode and plain-English business rules' },
                { sprint: 1, week: 2, assignee: 'AO', text: 'Define main entities and relationships (doctors, sessions, clinics, fee rules, tax, Medicare, super)' },
                { sprint: 1, week: 3, assignee: 'PE', text: 'Draft initial Postgres schema (tables, columns, relationships) in Supabase' },
                { sprint: 1, week: 3, assignee: 'PE', text: 'Create ERD and add to Wrike' },
                { sprint: 1, week: 3, assignee: 'AO', text: 'Review schema with Claude (normalisation, naming, indexing)' },
                { sprint: 1, week: 3, assignee: 'AO', text: 'Plan versioning for tax years and awards' },
                { sprint: 1, week: 4, assignee: 'PE', text: 'Implement schema and constraints in Supabase; create initial SQL migration scripts' },
                { sprint: 1, week: 4, assignee: 'PE', text: 'Smoke-test simple queries' },
                { sprint: 1, week: 4, assignee: 'AO', text: 'Sign off on schema; update Wrike and Calendar with "Schema complete" milestone' },
                // Sprint 2
                { sprint: 2, week: 5, assignee: 'PE', text: 'Install Rust toolchain locally; set up backend repo; choose Axum or Actix Web' },
                { sprint: 2, week: 5, assignee: 'PE', text: 'Add base routing, config loading, and health-check endpoint' },
                { sprint: 2, week: 5, assignee: 'AO', text: 'Define API design in Wrike (request/response shapes for /calculate-pay, /rates, /tax-year/:year)' },
                { sprint: 2, week: 5, assignee: 'AO', text: 'Use Claude to draft Rust module structure and shared types' },
                { sprint: 2, week: 6, assignee: 'PE', text: 'Integrate SQLx with Supabase/Postgres; implement basic DB connection and queries' },
                { sprint: 2, week: 6, assignee: 'PE', text: 'Add logging and error-handling middleware' },
                { sprint: 2, week: 6, assignee: 'AO', text: 'Set up GitHub Actions to build and run backend tests on each push/PR' },
                { sprint: 2, week: 6, assignee: 'AO', text: 'Start writing initial unit tests' },
                { sprint: 2, week: 7, assignee: 'PE', text: 'Implement Rust functions for core calculations (service fee, gross earnings, tax, Medicare levy)' },
                { sprint: 2, week: 7, assignee: 'PE', text: 'Use Claude to convert pseudocode to Rust and to refactor' },
                { sprint: 2, week: 7, assignee: 'AO', text: 'Implement API endpoints for POST /calculate-pay and GET /rates' },
                { sprint: 2, week: 7, assignee: 'AO', text: 'Define test scenarios in Wrike (inputs/expected outputs from old system)' },
                { sprint: 2, week: 8, assignee: 'PE', text: 'Implement GET /tax-year/:year and admin endpoints to read/update rates' },
                { sprint: 2, week: 8, assignee: 'PE', text: 'Build integration tests calling the real DB' },
                { sprint: 2, week: 8, assignee: 'AO', text: 'Validate outputs against known FileMaker examples' },
                { sprint: 2, week: 8, assignee: 'AO', text: 'Mark "Core APIs usable" milestone in Calendar' },
                // Sprint 3
                { sprint: 3, week: 9, assignee: 'PE', text: 'Scaffold Next.js app; configure TypeScript and basic routing' },
                { sprint: 3, week: 9, assignee: 'PE', text: 'Set up connection to GitHub and Vercel (Hobby)' },
                { sprint: 3, week: 9, assignee: 'AO', text: 'With Claude, design page structure and main form fields' },
                { sprint: 3, week: 9, assignee: 'AO', text: 'Create Next.js tasks in Wrike (login, calculator form, results view, admin)' },
                { sprint: 3, week: 10, assignee: 'PE', text: 'Build the main calculator form page (inputs for sessions/hours, location, doctor type)' },
                { sprint: 3, week: 10, assignee: 'PE', text: 'Wire form submit to Rust /calculate-pay API; handle loading and error states' },
                { sprint: 3, week: 10, assignee: 'AO', text: 'Add Tailwind CSS for base layout and styling' },
                { sprint: 3, week: 10, assignee: 'AO', text: 'Test flows end-to-end for simple scenarios; log bugs in Wrike' },
                { sprint: 3, week: 11, assignee: 'PE', text: 'Build results page with breakdown (gross, tax, Medicare levy, super, net)' },
                { sprint: 3, week: 11, assignee: 'PE', text: 'Add admin pages for rates and tax table management' },
                { sprint: 3, week: 11, assignee: 'AO', text: 'Polish validation messages and UX language with Claude\'s help' },
                { sprint: 3, week: 11, assignee: 'AO', text: 'Update Vercel deployment; verify behaviour in different browsers' },
                { sprint: 3, week: 12, assignee: 'PE', text: 'Fix front-end bugs; implement basic access control for admin pages' },
                { sprint: 3, week: 12, assignee: 'PE', text: 'Optimise API calls and UI performance' },
                { sprint: 3, week: 12, assignee: 'AO', text: 'Sign off on "MVP UI complete"; update Wrike and Calendar' },
                // Sprint 4
                { sprint: 4, week: 13, assignee: 'PE', text: 'Extend GitHub Actions to run both backend and frontend tests; deploy to staging' },
                { sprint: 4, week: 13, assignee: 'PE', text: 'Set up hosting for Rust API on Fly.io/Render and configure env vars' },
                { sprint: 4, week: 13, assignee: 'AO', text: 'Verify staging environments, update deployment documentation with Claude' },
                { sprint: 4, week: 13, assignee: 'AO', text: 'Enable Supabase Pro for production-like environment' },
                { sprint: 4, week: 14, assignee: 'PE', text: 'Review DB performance (indexes, slow queries); prototype Redis caching if required' },
                { sprint: 4, week: 14, assignee: 'PE', text: 'Integrate Grafana Cloud for logs and metrics; set up alerts' },
                { sprint: 4, week: 14, assignee: 'AO', text: 'Define cutover and rollback plan in Wrike; schedule cutover window' },
                { sprint: 4, week: 15, assignee: 'PE', text: 'Export FileMaker data to CSV, write import scripts for Postgres; run test imports' },
                { sprint: 4, week: 15, assignee: 'PE', text: 'Validate data (row counts, sample checks)' },
                { sprint: 4, week: 15, assignee: 'AO', text: 'Run parallel operation for sample users: compare outputs from old vs new app' },
                { sprint: 4, week: 16, assignee: 'PE', text: 'Finalise fixes from parallel run; re-run validations' },
                { sprint: 4, week: 16, assignee: 'PE', text: 'Execute final data import if needed before cutover' },
                { sprint: 4, week: 16, assignee: 'AO', text: 'Perform cutover (during low-risk window); direct all users to new app' },
                { sprint: 4, week: 16, assignee: 'AO', text: 'With Claude, write release notes and migration summary' }
            ]
        };

        // ==================== STATE ====================
        let state = {
            taskStatus: new Array(PROJECT_DATA.tasks.length).fill(false),
            delays: [],
            activities: [],
            startDate: '2025-01-06',
            supabase: null,
            wrikeToken: null,
            wrikeFolderId: null,
            userName: 'Anonymous',
            connected: false
        };

        // ==================== SUPABASE ====================
        async function connectSupabase() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                showToast('Please enter Supabase URL and Key', true);
                return;
            }

            try {
                updateConnectionStatus('connecting');
                state.supabase = supabase.createClient(url, key);
                
                // Test connection
                const { data, error } = await state.supabase.from('tasks').select('count');
                if (error) throw error;
                
                // Save credentials
                localStorage.setItem('supabaseUrl', url);
                localStorage.setItem('supabaseKey', key);
                
                // Load existing data
                await loadFromSupabase();
                
                // Subscribe to real-time changes
                setupRealtimeSubscription();
                
                state.connected = true;
                updateConnectionStatus('connected');
                showToast('Connected to Supabase! Real-time sync enabled.', false, true);
                
                // Enable buttons
                document.getElementById('sync-btn').disabled = false;
                document.getElementById('wrike-export-btn').disabled = false;
                
                // Log activity
                logActivity('connected', 'Connected to project');
                
            } catch (err) {
                console.error('Supabase connection error:', err);
                showToast('Connection failed: ' + err.message, true);
                updateConnectionStatus('disconnected');
            }
        }

        async function loadFromSupabase() {
            if (!state.supabase) return;
            
            try {
                // Load tasks
                const { data: tasks } = await state.supabase.from('tasks').select('*');
                if (tasks) {
                    tasks.forEach(t => {
                        if (t.task_index < state.taskStatus.length) {
                            state.taskStatus[t.task_index] = t.completed;
                        }
                    });
                }
                
                // Load delays
                const { data: delays } = await state.supabase.from('delays').select('*').order('created_at', { ascending: false });
                if (delays) state.delays = delays;
                
                // Load activities
                const { data: activities } = await state.supabase.from('activity').select('*').order('created_at', { ascending: false }).limit(50);
                if (activities) state.activities = activities;
                
                // Load settings
                const { data: settings } = await state.supabase.from('settings').select('*');
                if (settings) {
                    settings.forEach(s => {
                        if (s.key === 'start_date') state.startDate = s.value;
                    });
                }
                
                renderAll();
            } catch (err) {
                console.error('Load error:', err);
            }
        }

        function setupRealtimeSubscription() {
            if (!state.supabase) return;
            
            state.supabase.channel('project-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, payload => {
                    if (payload.new && payload.new.task_index !== undefined) {
                        state.taskStatus[payload.new.task_index] = payload.new.completed;
                        renderAll();
                    }
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'delays' }, async () => {
                    const { data } = await state.supabase.from('delays').select('*').order('created_at', { ascending: false });
                    if (data) state.delays = data;
                    renderDelays();
                    updateStats();
                })
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'activity' }, payload => {
                    if (payload.new) {
                        state.activities.unshift(payload.new);
                        renderActivities();
                    }
                })
                .subscribe();
        }

        async function syncTaskToSupabase(index, completed) {
            if (!state.supabase) return;
            
            try {
                const { error } = await state.supabase.from('tasks').upsert({
                    task_index: index,
                    completed: completed,
                    completed_by: completed ? state.userName : null,
                    completed_at: completed ? new Date().toISOString() : null
                }, { onConflict: 'task_index' });
                
                if (error) throw error;
                
                // Log activity
                const task = PROJECT_DATA.tasks[index];
                logActivity(completed ? 'completed' : 'uncompleted', `Task: "${task.text.substring(0, 50)}..."`);
                
            } catch (err) {
                console.error('Sync error:', err);
                showToast('Sync failed: ' + err.message, true);
            }
        }

        async function syncDelayToSupabase(delay) {
            if (!state.supabase) return;
            
            try {
                const { error } = await state.supabase.from('delays').insert({
                    week: delay.week,
                    days: delay.days,
                    category: delay.category,
                    reason: delay.reason,
                    impact: delay.impact,
                    created_by: state.userName
                });
                
                if (error) throw error;
                logActivity('delay', `Added ${delay.days} day delay for Week ${delay.week}`);
                
            } catch (err) {
                console.error('Delay sync error:', err);
            }
        }

        async function logActivity(action, details) {
            if (!state.supabase) return;
            
            try {
                await state.supabase.from('activity').insert({
                    user_name: state.userName,
                    action: action,
                    details: details
                });
            } catch (err) {
                console.error('Activity log error:', err);
            }
        }

        // ==================== WRIKE EXPORT ====================
        async function exportToWrike() {
            const token = state.wrikeToken;
            if (!token) {
                showToast('Please configure Wrike token in Setup', true);
                return;
            }

            const tasks = PROJECT_DATA.tasks.map((t, i) => ({
                title: `[S${t.sprint}W${t.week}] ${t.text.substring(0, 100)}`,
                description: `Sprint ${t.sprint}, Week ${t.week}\nAssignee: ${t.assignee}\n\n${t.text}`,
                status: state.taskStatus[i] ? 'Completed' : 'Active'
            }));

            // Show preview
            document.getElementById('wrike-preview').innerHTML = `<pre>${JSON.stringify(tasks.slice(0, 5), null, 2)}\n... and ${tasks.length - 5} more tasks</pre>`;
            document.getElementById('wrike-modal').classList.add('active');
        }

        async function confirmWrikeExport() {
            const token = state.wrikeToken;
            const folderId = state.wrikeFolderId;
            
            showToast('Exporting to Wrike...', false);
            
            try {
                for (const task of PROJECT_DATA.tasks.slice(0, 5)) { // Limited for demo
                    const response = await fetch(`https://www.wrike.com/api/v4/folders/${folderId || 'root'}/tasks`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: `[S${task.sprint}W${task.week}] ${task.text.substring(0, 100)}`,
                            description: task.text
                        })
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.errorDescription || 'Wrike API error');
                    }
                }
                
                showToast('Tasks exported to Wrike successfully!', false, true);
                document.getElementById('wrike-modal').classList.remove('active');
                logActivity('wrike-export', 'Exported tasks to Wrike');
                
            } catch (err) {
                console.error('Wrike export error:', err);
                showToast('Wrike export failed: ' + err.message, true);
            }
        }

        // ==================== UI RENDERING ====================
        function renderAll() {
            renderSprints();
            renderDelays();
            renderActivities();
            renderSummary();
            updateStats();
            updateDates();
        }

        function renderSprints() {
            const container = document.getElementById('sprint-container');
            container.innerHTML = PROJECT_DATA.sprints.map(sprint => {
                const sprintTasks = PROJECT_DATA.tasks.filter(t => t.sprint === sprint.id);
                const weeks = [...new Set(sprintTasks.map(t => t.week))];
                const completedCount = sprintTasks.filter((_, i) => {
                    const globalIndex = PROJECT_DATA.tasks.findIndex(t => t === sprintTasks[i]);
                    return state.taskStatus[globalIndex];
                }).length;
                const progress = Math.round((completedCount / sprintTasks.length) * 100);

                return `
                    <div class="sprint-card sprint-${sprint.id}">
                        <div class="sprint-header">
                            <span class="sprint-number">Sprint ${sprint.id}</span>
                            <h3 class="sprint-title">${sprint.name}</h3>
                            <div class="sprint-meta"><span>üìÜ Weeks ${sprint.weeks}</span><span>‚è±Ô∏è ${sprint.effort}</span><span>üíµ ${sprint.cost}</span></div>
                            <div class="sprint-dates" data-sprint="${sprint.id}"></div>
                        </div>
                        <div class="sprint-progress">
                            <div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>
                            <div class="progress-label"><span>${completedCount} / ${sprintTasks.length} tasks</span><span>${progress}%</span></div>
                        </div>
                        <div class="sprint-body">
                            ${weeks.map(week => renderWeek(sprint.id, week, sprintTasks.filter(t => t.week === week))).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners for checkboxes
            document.querySelectorAll('.task-checkbox').forEach(cb => {
                cb.addEventListener('click', () => toggleTask(parseInt(cb.dataset.index)));
            });

            // Add event listeners for accordions
            document.querySelectorAll('.week-header').forEach(h => {
                h.addEventListener('click', () => h.parentElement.classList.toggle('open'));
            });
        }

        function renderWeek(sprintId, weekNum, tasks) {
            const peTasks = tasks.filter(t => t.assignee === 'PE');
            const aoTasks = tasks.filter(t => t.assignee === 'AO');

            return `
                <div class="week-accordion">
                    <div class="week-header">
                        <div class="week-header-left">
                            <span class="week-title">Week ${weekNum}</span>
                            <span class="week-date" data-week="${weekNum}"></span>
                        </div>
                        <span class="week-toggle">‚ñº</span>
                    </div>
                    <div class="week-content">
                        ${peTasks.length ? `<div class="task-group"><div class="task-group-title pe">PE Tasks</div>${peTasks.map(t => renderTask(t)).join('')}</div>` : ''}
                        ${aoTasks.length ? `<div class="task-group"><div class="task-group-title">AO Tasks</div>${aoTasks.map(t => renderTask(t)).join('')}</div>` : ''}
                    </div>
                </div>
            `;
        }

        function renderTask(task) {
            const index = PROJECT_DATA.tasks.indexOf(task);
            const completed = state.taskStatus[index];
            return `
                <div class="task-item ${completed ? 'completed' : ''}">
                    <div class="task-checkbox ${completed ? 'checked' : ''}" data-index="${index}"></div>
                    <span class="task-text">${task.text}</span>
                </div>
            `;
        }

        function toggleTask(index) {
            state.taskStatus[index] = !state.taskStatus[index];
            renderSprints();
            updateStats();
            saveLocal();
            
            if (state.connected) {
                syncTaskToSupabase(index, state.taskStatus[index]);
            }
        }

        function renderDelays() {
            const list = document.getElementById('delay-list');
            if (state.delays.length === 0) {
                list.innerHTML = '<div class="no-delays">No delays recorded yet.</div>';
            } else {
                const categoryColors = { resource: 'badge-violet', technical: 'badge-teal', external: 'badge-amber', scope: 'badge-rose', data: 'badge-teal', environment: 'badge-violet' };
                list.innerHTML = state.delays.map((d, i) => `
                    <div class="delay-item">
                        <button class="remove-delay-btn" data-index="${i}">√ó</button>
                        <div class="delay-item-header">
                            <span class="delay-week">Week ${d.week}<span class="badge delay-category ${categoryColors[d.category]}">${d.category}</span></span>
                            <span class="delay-days">+${d.days} day${d.days > 1 ? 's' : ''}</span>
                        </div>
                        <div class="delay-reason">${d.reason}</div>
                        ${d.impact ? `<div class="delay-impact">Impact: ${d.impact}</div>` : ''}
                        ${d.created_by ? `<div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem;">Added by ${d.created_by}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        function renderActivities() {
            const log = document.getElementById('activity-log');
            if (state.activities.length === 0) {
                log.innerHTML = '<div class="no-delays">No activity yet. Connect to Supabase to see real-time updates.</div>';
            } else {
                log.innerHTML = state.activities.map(a => `
                    <div class="activity-item">
                        <span class="activity-time">${new Date(a.created_at).toLocaleString()}</span>
                        <span class="activity-text"><span class="activity-user">${a.user_name}</span> ${a.action}: ${a.details || ''}</span>
                    </div>
                `).join('');
            }
        }

        function renderSummary() {
            const tbody = document.getElementById('summary-table-body');
            tbody.innerHTML = PROJECT_DATA.sprints.map(sprint => {
                const sprintTasks = PROJECT_DATA.tasks.filter(t => t.sprint === sprint.id);
                const completedCount = sprintTasks.filter(t => {
                    const index = PROJECT_DATA.tasks.indexOf(t);
                    return state.taskStatus[index];
                }).length;
                const progress = Math.round((completedCount / sprintTasks.length) * 100);
                const badges = ['badge-teal', 'badge-violet', 'badge-amber', 'badge-rose'];
                
                return `<tr>
                    <td><span class="badge ${badges[sprint.id - 1]}">Sprint ${sprint.id}</span></td>
                    <td>${sprint.weeks}</td>
                    <td data-sprint-summary="${sprint.id}"></td>
                    <td>${sprint.name}</td>
                    <td class="table-highlight">${progress}%</td>
                </tr>`;
            }).join('');
        }

        function updateStats() {
            const completed = state.taskStatus.filter(Boolean).length;
            const total = state.taskStatus.length;
            const percent = Math.round((completed / total) * 100);
            document.getElementById('completed-stat').textContent = `${percent}%`;
            
            const totalDelayDays = state.delays.reduce((sum, d) => sum + parseInt(d.days || 0), 0);
            document.getElementById('delay-stat').textContent = `${totalDelayDays} days`;
        }

        function updateDates() {
            const startDate = new Date(state.startDate);
            document.getElementById('start-date').value = state.startDate;
            
            // Update week dates
            document.querySelectorAll('[data-week]').forEach(el => {
                const week = parseInt(el.dataset.week) - 1;
                const weekStart = new Date(startDate);
                weekStart.setDate(startDate.getDate() + (week * 7));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 4);
                el.textContent = `${formatDate(weekStart)}‚Äì${formatDate(weekEnd)}`;
            });
            
            // Update sprint dates
            const sprintRanges = [[0, 3], [4, 7], [8, 11], [12, 15]];
            document.querySelectorAll('[data-sprint]').forEach(el => {
                const sprint = parseInt(el.dataset.sprint) - 1;
                const [startWeek, endWeek] = sprintRanges[sprint];
                const sprintStart = new Date(startDate);
                sprintStart.setDate(startDate.getDate() + (startWeek * 7));
                const sprintEnd = new Date(startDate);
                sprintEnd.setDate(startDate.getDate() + (endWeek * 7) + 4);
                el.textContent = `${formatDate(sprintStart)} ‚Äì ${formatDate(sprintEnd)} ${sprintEnd.getFullYear()}`;
            });
            
            // Update summary table dates
            document.querySelectorAll('[data-sprint-summary]').forEach(el => {
                const sprint = parseInt(el.dataset.sprintSummary) - 1;
                const [startWeek, endWeek] = sprintRanges[sprint];
                const sprintStart = new Date(startDate);
                sprintStart.setDate(startDate.getDate() + (startWeek * 7));
                const sprintEnd = new Date(startDate);
                sprintEnd.setDate(startDate.getDate() + (endWeek * 7) + 4);
                el.textContent = `${formatDate(sprintStart)} ‚Äì ${formatDate(sprintEnd)}`;
            });
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        }

        function updateConnectionStatus(status) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            dot.className = 'status-dot ' + status;
            
            if (status === 'connected') {
                text.innerHTML = 'Connected ‚Äì <strong>Real-time Sync Active</strong>';
            } else if (status === 'connecting') {
                text.innerHTML = 'Connecting...';
            } else {
                text.innerHTML = 'Not connected ‚Äì <strong>Offline Mode</strong>';
            }
        }

        // ==================== LOCAL STORAGE ====================
        function saveLocal() {
            localStorage.setItem('dpcState', JSON.stringify({
                taskStatus: state.taskStatus,
                delays: state.delays,
                startDate: state.startDate,
                userName: state.userName
            }));
        }

        function loadLocal() {
            const saved = localStorage.getItem('dpcState');
            if (saved) {
                const data = JSON.parse(saved);
                state.taskStatus = data.taskStatus || state.taskStatus;
                state.delays = data.delays || [];
                state.startDate = data.startDate || state.startDate;
                state.userName = data.userName || 'Anonymous';
            }
            
            // Load Wrike settings
            state.wrikeToken = localStorage.getItem('wrikeToken');
            state.wrikeFolderId = localStorage.getItem('wrikeFolderId');
            
            // Load user name
            const userName = localStorage.getItem('userName');
            if (userName) state.userName = userName;
            document.getElementById('user-name').value = state.userName;
        }

        // ==================== UTILITIES ====================
        function showToast(message, isError = false, isSuccess = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '') + (isSuccess ? ' success' : '');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadLocal();
            renderAll();
            
            // Try to auto-connect to Supabase
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            if (savedUrl && savedKey) {
                document.getElementById('supabase-url').value = savedUrl;
                document.getElementById('supabase-key').value = savedKey;
                connectSupabase();
            }
        });

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Setup modal
        document.getElementById('setup-btn').addEventListener('click', () => {
            document.getElementById('setup-modal').classList.add('active');
        });
        document.getElementById('close-setup-btn').addEventListener('click', () => {
            document.getElementById('setup-modal').classList.remove('active');
        });
        document.getElementById('connect-supabase-btn').addEventListener('click', connectSupabase);
        
        // Schema modal
        document.getElementById('show-schema-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('schema-modal').classList.add('active');
        });
        document.getElementById('close-schema-btn').addEventListener('click', () => {
            document.getElementById('schema-modal').classList.remove('active');
        });
        document.getElementById('copy-schema-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('schema-sql').textContent);
            showToast('SQL copied to clipboard!', false, true);
        });

        // Wrike settings
        document.getElementById('save-wrike-btn').addEventListener('click', () => {
            state.wrikeToken = document.getElementById('wrike-token').value.trim();
            state.wrikeFolderId = document.getElementById('wrike-folder').value.trim();
            localStorage.setItem('wrikeToken', state.wrikeToken);
            localStorage.setItem('wrikeFolderId', state.wrikeFolderId);
            showToast('Wrike settings saved!', false, true);
        });

        // User name
        document.getElementById('user-name').addEventListener('change', (e) => {
            state.userName = e.target.value.trim() || 'Anonymous';
            localStorage.setItem('userName', state.userName);
        });

        // Update dates
        document.getElementById('update-dates-btn').addEventListener('click', () => {
            state.startDate = document.getElementById('start-date').value;
            updateDates();
            saveLocal();
            showToast('Dates updated!', false, true);
        });

        // Sync button
        document.getElementById('sync-btn').addEventListener('click', () => {
            if (state.connected) {
                loadFromSupabase();
                showToast('Synced with Supabase!', false, true);
            }
        });

        // Wrike export
        document.getElementById('wrike-export-btn').addEventListener('click', exportToWrike);
        document.getElementById('cancel-wrike-btn').addEventListener('click', () => {
            document.getElementById('wrike-modal').classList.remove('active');
        });
        document.getElementById('confirm-wrike-btn').addEventListener('click', confirmWrikeExport);

        // Delay modal
        document.getElementById('add-delay-btn').addEventListener('click', () => {
            document.getElementById('delay-modal').classList.add('active');
        });
        document.getElementById('cancel-delay-btn').addEventListener('click', () => {
            document.getElementById('delay-modal').classList.remove('active');
        });
        document.getElementById('delay-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const delay = {
                week: parseInt(document.getElementById('delay-week').value),
                days: parseInt(document.getElementById('delay-days').value),
                category: document.getElementById('delay-category').value,
                reason: document.getElementById('delay-reason').value,
                impact: document.getElementById('delay-impact').value,
                created_by: state.userName
            };
            state.delays.unshift(delay);
            renderDelays();
            updateStats();
            saveLocal();
            
            if (state.connected) {
                syncDelayToSupabase(delay);
            }
            
            document.getElementById('delay-modal').classList.remove('active');
            document.getElementById('delay-form').reset();
            showToast('Delay logged!', false, true);
        });

        // Remove delay
        document.getElementById('delay-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-delay-btn')) {
                const index = parseInt(e.target.dataset.index);
                state.delays.splice(index, 1);
                renderDelays();
                updateStats();
                saveLocal();
            }
        });
    </script>
</body>
</html>
